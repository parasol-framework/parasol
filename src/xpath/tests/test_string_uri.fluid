-- XPath string and URI function coverage

   include 'xml'

-----------------------------------------------------------------------------------------------------------------------

function testCodepointConversions()
   local xml = glTestXML

   local err, text = xml.mtEvaluate("codepoints-to-string(string-to-codepoints('café'))")
   assert(text == 'café', "codepoints-to-string should decode UTF-8 codepoints")

   local err, fourth = xml.mtEvaluate("string-to-codepoints('café')[4]")
   assert(fourth == '233', "string-to-codepoints should report the final codepoint value")
end

-----------------------------------------------------------------------------------------------------------------------

function testStringFunctions()
   local xml = glTestXML

   local err, temp_compareResult = xml.mtEvaluate("compare('abc','def')")
   local compareResult = tonumber(temp_compareResult)
   assert(compareResult == -1, "compare should report that abc comes before def")

   local err, equalResult = xml.mtEvaluate("codepoint-equal('same','same')")
   assert(equalResult == 'true', "codepoint-equal should return true for identical strings")

   local err, suffixMatch = xml.mtEvaluate("ends-with('hello world','world')")
   assert(suffixMatch == 'true', "ends-with should confirm matching suffix")

   local err, joined = xml.mtEvaluate("string-join(/root/part, '-')")
   assert(joined == 'a-b-c', "string-join should concatenate entries with separators")

   local err, nfcValue = xml.mtEvaluate("normalize-unicode('café','NFC')")
   assert(nfcValue == 'café', "normalize-unicode NFC form should preserve composed characters")

   local err, nfdValue = xml.mtEvaluate("normalize-unicode('café','NFD')")
   assert(nfdValue:sub(1, 3) == 'caf', "normalize-unicode NFD form should begin with the original prefix")

   local err, iriValue = xml.mtEvaluate("iri-to-uri('https://example.com/é')")
   assert(iriValue == 'https://example.com/%C3%A9', "iri-to-uri should percent encode non ASCII characters")
end

-----------------------------------------------------------------------------------------------------------------------

function testAnalyzeString()
   local xml = glTestXML

   local err, first = xml.mtEvaluate("analyze-string('abc123','([0-9]+)')[1]")
   assert(first == 'non-match:abc', "analyze-string should report unmatched prefix, got '" .. nz(first,'NIL') .. "'")

   local err, second = xml.mtEvaluate("analyze-string('abc123','([0-9]+)')[2]")
   assert(second == 'match:123', "analyze-string should report matched text, got '" .. nz(second,'NIL') .. "'")

   local err, third = xml.mtEvaluate("analyze-string('abc123','([0-9]+)')[3]")
   assert(third == 'group1:123', "analyze-string should include capture groups, got '" .. nz(third,'NIL') .. "'")

   local err, gap = xml.mtEvaluate("analyze-string('ab12cd34ef','([0-9]+)')[4]")
   assert(gap == 'non-match:cd', "analyze-string should report intermediate gaps once, got '" .. nz(gap,'NIL') .. "'")

   local err, secondMatch = xml.mtEvaluate("analyze-string('ab12cd34ef','([0-9]+)')[5]")
   assert(secondMatch == 'match:34', "analyze-string should capture subsequent matches, got '" .. nz(secondMatch,'NIL') .. "'")

   local err, secondGroup = xml.mtEvaluate("analyze-string('ab12cd34ef','([0-9]+)')[6]")
   assert(secondGroup == 'group1:34', "analyze-string should report groups for each match, got '" .. nz(secondGroup,'NIL') .. "'")

   local err, tail = xml.mtEvaluate("analyze-string('ab12cd34ef','([0-9]+)')[7]")
   assert(tail == 'non-match:ef', "analyze-string should append the trailing suffix once, got '" .. nz(tail,'NIL') .. "'")
end

-----------------------------------------------------------------------------------------------------------------------

function testResolveUri()
   local xml = glTestXML

   local err, resolved = xml.mtEvaluate("resolve-uri('images/icon.png','http://example.com/docs/start.xml')")
   assert(resolved == 'http://example.com/docs/images/icon.png', "resolve-uri should combine base and relative paths")

   local err, up = xml.mtEvaluate("resolve-uri('../shared/data.json','http://example.com/docs/dir/page.html')")
   assert(up == 'http://example.com/docs/shared/data.json', "resolve-uri should normalise parent directory references")

   local err, absolute = xml.mtEvaluate("resolve-uri('https://cdn.example.com/app.js','http://example.com/docs/start.xml')")
   assert(absolute == 'https://cdn.example.com/app.js', "resolve-uri should return absolute URIs unchanged")
end

-----------------------------------------------------------------------------------------------------------------------

function testFormattingFunctions()
   local xml = glTestXML

   local err, formattedDate = xml.mtEvaluate("format-date('2024-05-17','[Y0001]-[M01]-[D01]')")
   assert(formattedDate == '2024-05-17', "format-date should honour the supplied picture")

   local err, formattedTime = xml.mtEvaluate("format-time('12:34:56','[H01]:[m01]:[s01]')")
   assert(formattedTime == '12:34:56', "format-time should produce the requested components")

   local err, formattedDateTime = xml.mtEvaluate("format-dateTime('2024-05-17T12:34:56','[Y0001]-[M01]-[D01]T[H01]:[m01]')")
   assert(formattedDateTime == '2024-05-17T12:34', "format-dateTime should format combined values")

   local err, formattedInteger = xml.mtEvaluate("format-integer(1234567,'#,##0')")
   assert(formattedInteger == '1,234,567', "format-integer should insert group separators")
end

-----------------------------------------------------------------------------------------------------------------------

return {
   tests = {
      'testCodepointConversions', 'testStringFunctions', 'testAnalyzeString',
      'testResolveUri', 'testFormattingFunctions'
   },
   init = function()
      glTestXML = obj.new("xml", {
         statement = '<root base="http://example.com/docs/start.xml">' ..
                     '<part>a</part>' ..
                     '<part>b</part>' ..
                     '<part>c</part>' ..
                     '</root>'
      })
   end
}
