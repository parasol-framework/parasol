-- Group handling, numbering, and backreference semantics

@Test function NestedCaptures()
   local matcher = regex.new("((\\w+)-(\\d+))")
   local match = matcher.match("item-42")
   assert(match, "Nested groups should capture content")
   assert(match[0] is "item-42", "Full match should be first entry")
   assert(match[1] is "item-42", "Outer group should mirror full match")
   assert(match[2] is "item", "Inner word capture should extract prefix")
   assert(match[3] is "42", "Inner numeric capture should extract suffix")
end

@Test function NonCapturingGroupCount()
   local matcher = regex.new("(?:pre-)?(value)")
   local match = matcher.match("pre-value")
   assert(match and #match is 2, "Non capturing groups should not appear in result table")
   assert(match[1] is "value", "Capturing group should contain the payload")
end

@Test function OptionalBackreference()
   local matcher = regex.new("(\\w+)\\s+\\1")
   assert(matcher.test("hello hello"), "Backreference should match repeated word")
   assert(not matcher.test("hello world"), "Mismatched second word should fail backreference")
end

@Test function BackreferenceInReplace()
   local matcher = regex.new("(\\w+),(\\w+)")
   local result = matcher.replace("last,first", "$2 $1")
   assert(result is "first last", "Replacement should respect capture ordering")
end

@Test function SearchCapturesPreserveIndices()
   local matcher = regex.new("(a)?b")
   local results = matcher.search("bbab")
   assert(results and #results is 3, "Search should produce one entry per match")
   assert(results[0][1] is "", "Optional group should be empty when unmatched")
   assert(results[1][1] is "", "Second match should also record empty capture")
   assert(results[2][1] is "a", "Third match should record captured character")
end

@Test function NamedBackreference()
   local matcher = regex.new("(?<word>\\w+)-\\k<word>")
   assert(matcher.test("repeat-repeat"), "Named backreference should accept identical tokens")
   assert(not matcher.test("repeat-other"), "Named backreference should reject differing suffix")
end

@Test function LookaheadNamedBackreference()
   local matcher = regex.new("^(?=(?<prefix>\\w{3}))\\w+\\k<prefix>$")
   assert(matcher.test("foobarfoo"), "Lookahead capture should be reusable later in the pattern")
   assert(not matcher.test("foobarbar"), "Lookahead capture should still enforce the trailing repetition")
end

@Test function MixedNamedAndNumberedReferences()
   local matcher = regex.new("^(?<word>\\w+)-(\\d+) \\1 \\k<word>$")
   assert(matcher.test("value-01 value value"), "Named and numbered references should target the same capture")
   assert(not matcher.test("value-01 value other"), "Mismatch should cause the combined reference check to fail")
end
