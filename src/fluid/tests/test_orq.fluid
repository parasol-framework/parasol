-- Flute tests for the ? operator (extended falsey: nil, false, 0, "")

function testNil()
   local v = nil ? "A"
   assert(v is "A", "Failed nil case: expected 'A', got '" .. nz(v, 'NIL') .. "'")
end

function testFalse()
   local v = false ? "A"
   assert(v is "A", "Failed false case: expected 'A', got '" .. tostring(v) .. "'")
end

function testZero()
   local v = 0 ? "A"
   assert(v is "A", "Failed zero case: expected 'A', got '" .. tostring(v) .. "'")
end

function testEmptyString()
   local v = "" ? "A"
   assert(v is "A", "Failed empty string case: expected 'A', got '" .. tostring(v) .. "'")
end

function testTruthyString()
   local v = "X" ? "A"
   assert(v is "X", "Failed truthy string case: expected 'X', got '" .. tostring(v) .. "'")
end

function testTruthyNumber()
   local v = 5 ? "A"
   assert(v is 5, "Failed truthy number case: expected 5, got '" .. tostring(v) .. "'")
end

-- Ensure RHS is not evaluated when LHS is truthy
function testShortCircuitTruth()
   local function rhs()
      error("RHS should not be evaluated when LHS is truthy")
   end
   local v = "X" ? rhs()
   assert(v is "X", "Failed short-circuit truth: expected 'X', got '" .. tostring(v) .. "'")
end

-- Ensure RHS is evaluated exactly once when LHS is extended-falsey
function testRHSOnce()
   local count = 0
   local function rhs()
      count += 1
      return "Y"
   end
   local v = 0 ? rhs()
   assert(v is "Y", "Failed RHS once value: expected 'Y', got '" .. tostring(v) .. "'")
   assert(count is 1, "Failed RHS once count: expected 1, got " .. tostring(count))
end

-- Chaining behaviour
function testChaining()
   local v1 = "" ? 0 ? "A"
   assert(v1 is "A", "Failed chaining case 1: expected 'A', got '" .. tostring(v1) .. "'")

   local v2 = "X" ? "" ? "A"
   assert(v2 is "X", "Failed chaining case 2: expected 'X', got '" .. tostring(v2) .. "'")
end

-- Interaction with logical or: ensure semantics differ (0 and "" are treated as truthy by Lua or)
function testDifferenceFromLuaOr()
   local a = 0 or "B"      -- Lua or: 0 is truthy
   local b = 0 ? "B"        -- ?: 0 is falsey
   assert(a is 0, "Sanity: Lua 'or' should keep 0; got '" .. tostring(a) .. "'")
   assert(b is "B", "? should replace 0 with RHS; got '" .. tostring(b) .. "'")

   local c = "" or "C"      -- Lua or: empty string is truthy
   local d = "" ? "C"       -- ?: empty string is falsey
   assert(c is "", "Sanity: Lua 'or' should keep empty string; got '" .. tostring(c) .. "'")
   assert(d is "C", "? should replace empty string with RHS; got '" .. tostring(d) .. "'")
end

function testRuntimeZero()
   local x = 0
   local v = x ? "A"
   assert(v is "A", "Runtime zero test failed: expected 'A', got '" .. tostring(v) .. "'")
end

-----------------------------------------------------------------------------------------------------------------------

   return {
      tests = {
         'testNil', 'testFalse', 'testZero', 'testEmptyString', 'testTruthyString', 'testTruthyNumber',
         'testShortCircuitTruth', 'testRHSOnce', 'testChaining', 'testDifferenceFromLuaOr',
         'testRuntimeZero'
      }
   }
