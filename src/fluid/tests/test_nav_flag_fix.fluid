-- Test safe navigation flag interference fixes

local passed = 0
local failed = 0

local function test(name, condition, expected, actual)
   if condition then
      print("âœ“ " .. name)
      passed += 1
   else
      print("âœ— " .. name)
      print("  Expected: " .. tostring(expected))
      print("  Actual: " .. tostring(actual))
      failed += 1
   end
end

-- Test 1: Safe nav followed by if-empty (nil result)
print("\n=== Test 1: Safe nav + if-empty (nil result) ===")
local guest = nil
local result = guest?.profile?.name ? "Guest"
test("guest?.profile?.name ? 'Guest' should return 'Guest'",
     result is "Guest", "Guest", result)

-- Test 2: Safe nav followed by if-empty (non-nil result)
print("\n=== Test 2: Safe nav + if-empty (non-nil result) ===")
local user = { profile = { name = "Alice" } }
local name = user?.profile?.name ? "Guest"
test("user?.profile?.name ? 'Guest' should return 'Alice'",
     name is "Alice", "Alice", name)

-- Test 3: Parenthesized safe nav + if-empty (nil result)
print("\n=== Test 3: Parenthesized safe nav + if-empty (nil result) ===")
local obj = { a = { b = nil } }
local v = (obj?.a?.b?.c) ? "default"
test("(obj?.a?.b?.c) ? 'default' should return 'default'",
     v is "default", "default", v)

-- Test 4: Parenthesized safe nav + if-empty (non-nil result)
print("\n=== Test 4: Parenthesized safe nav + if-empty (non-nil result) ===")
local obj2 = { a = { b = { c = "value" } } }
local v2 = (obj2?.a?.b?.c) ? "default"
test("(obj2?.a?.b?.c) ? 'default' should return 'value'",
     v2 is "value", "value", v2)

-- Test 5: Safe nav with false value + if-empty
print("\n=== Test 5: Safe nav with false value + if-empty ===")
local obj3 = { flag = false }
local v3 = obj3?.flag ? "default"
test("obj3?.flag ? 'default' should return 'default' (false is falsey)",
     v3 is "default", "default", v3)

-- Test 6: Safe nav with zero value + if-empty
print("\n=== Test 6: Safe nav with zero value + if-empty ===")
local obj4 = { count = 0 }
local v4 = obj4?.count ? "default"
test("obj4?.count ? 'default' should return 'default' (0 is falsey)",
     v4 is "default", "default", v4)

-- Test 7: Safe nav with empty string + if-empty
print("\n=== Test 7: Safe nav with empty string + if-empty ===")
local obj5 = { text = "" }
local v5 = obj5?.text ? "default"
test("obj5?.text ? 'default' should return 'default' ('' is falsey)",
     v5 is "default", "default", v5)

-- Test 8: Multi-level safe nav still works (no if-empty)
print("\n=== Test 8: Multi-level safe nav without if-empty ===")
local deep = nil
local val = deep?.a?.b?.c?.d
test("deep?.a?.b?.c?.d should return nil",
     val is nil, nil, val)

-- Test 9: Safe nav with valid deep path (no if-empty)
print("\n=== Test 9: Safe nav with valid deep path ===")
local deep2 = { a = { b = { c = { d = 42 } } } }
local val2 = deep2?.a?.b?.c?.d
test("deep2?.a?.b?.c?.d should return 42",
     val2 is 42, 42, val2)

-- Test 10: Safe method call still works
print("\n=== Test 10: Safe method call ===")
local obj6 = {
   value = 10,
   getValue = function(self) return self.value end
}
local val3 = obj6?:getValue()
test("obj6?:getValue() should return 10",
     val3 is 10, 10, val3)

-- Test 11: Safe method call on nil
print("\n=== Test 11: Safe method call on nil ===")
local obj7 = nil
local val4 = obj7?:getValue()
test("obj7?:getValue() should return nil",
     val4 is nil, nil, val4)

-- Test 12: Safe indexing still works
print("\n=== Test 12: Safe indexing ===")
local arr = { 10, 20, 30 }
local val5 = arr?[2]
test("arr?[2] should return 20",
     val5 is 20, 20, val5)

-- Test 13: Safe indexing on nil
print("\n=== Test 13: Safe indexing on nil ===")
local arr2 = nil
local val6 = arr2?[1]
test("arr2?[1] should return nil",
     val6 is nil, nil, val6)

-- Test 14: Chained safe navigation then if-empty with method
print("\n=== Test 14: Chained safe nav + method + if-empty ===")
local service = nil
local result2 = service?.api?.getData() ? "no data"
test("service?.api?.getData() ? 'no data' should return 'no data'",
     result2 is "no data", "no data", result2)

-- Summary
print("\n" .. string.rep("=", 50))
print("RESULTS: " .. passed .. " passed, " .. failed .. " failed")
print(string.rep("=", 50))

if failed > 0 then
   error("Some tests failed!")
end

return {
   tests = {} -- Dummy for flute compatibility
}
