-- Flute tests for horizontal ellipsis (…) operator
-- The … Unicode character (U+2026) should map to ... (varargs)

function testEllipsisBasic()
   local function variadic(…)
      return {…}
   end

   local result = variadic(1, 2, 3)
   assert(#result is 3, "Variadic with 3 args should have 3 elements")
   assert(result[0] is 1, "First element should be 1")
   assert(result[1] is 2, "Second element should be 2")
   assert(result[2] is 3, "Third element should be 3")
end

function testEllipsisNoArgs()
   local function variadic(…)
      return {…}
   end

   local result = variadic()
   assert(#result is 0, "Variadic with no args should have 0 elements")
end

function testEllipsisSingleArg()
   local function variadic(…)
      return {…}
   end

   local result = variadic("hello")
   assert(#result is 1, "Variadic with 1 arg should have 1 element")
   assert(result[0] is "hello", "First element should be 'hello'")
end

function testEllipsisMultipleTypes()
   local function variadic(…)
      return {…}
   end

   -- Note: nil values are dropped by Lua when captured with {...}
   local result = variadic(1, "two", 3.0, true)
   assert(#result is 4, "Variadic with 4 args should have 4 elements")
   assert(result[0] is 1, "First element should be 1")
   assert(result[1] is "two", "Second element should be 'two'")
   assert(result[2] is 3.0, "Third element should be 3.0")
   assert(result[3] is true, "Fourth element should be true")
end

function testEllipsisWithNamedParams()
   local function variadic(a, b, …)
      return a, b, {…}
   end

   local a, b, rest = variadic(10, 20, 30, 40, 50)
   assert(a is 10, "First param should be 10")
   assert(b is 20, "Second param should be 20")
   assert(#rest is 3, "Rest should have 3 elements")
   assert(rest[0] is 30, "Rest[0] should be 30")
   assert(rest[1] is 40, "Rest[1] should be 40")
   assert(rest[2] is 50, "Rest[2] should be 50")
end

function testEllipsisForwarding()
   local function inner(…)
      return {…}
   end

   local function wrapper(…)
      return inner(…)
   end

   local result = wrapper("a", "b", "c")
   assert(#result is 3, "Forwarded variadic should have 3 elements")
   assert(result[0] is "a", "Element 0 should be 'a'")
   assert(result[1] is "b", "Element 1 should be 'b'")
   assert(result[2] is "c", "Element 2 should be 'c'")
end

function testEllipsisUnpacking()
   local function variadic(…)
      local count = 0
      for _ in ipairs({…}) do
         count++
      end
      return count
   end

   local result = variadic(1, 2, 3, 4, 5)
   assert(result is 5, "Count of 5 args should be 5")
end

function testEllipsisInStringFormat()
   local function format_args(fmt, …)
      return string.format(fmt, …)
   end

   local result = format_args("Number: %d, String: %s", 42, "test")
   assert(result is "Number: 42, String: test", "Format with variadic args should work")
end

function testAsciiEllipsisMixedWithUnicode()
   -- Test that both ASCII ... and Unicode … can coexist
   local function ascii_variadic(...)
      return {...}
   end

   local function unicode_variadic(…)
      return {…}
   end

   local ascii_result = ascii_variadic(1, 2, 3)
   local unicode_result = unicode_variadic(1, 2, 3)

   assert(#ascii_result is 3, "ASCII ... should work")
   assert(#unicode_result is 3, "Unicode … should work")
   assert(ascii_result[0] is unicode_result[0], "Both should capture same values")
end

return {
   tests = {
      testEllipsisBasic,
      testEllipsisNoArgs,
      testEllipsisSingleArg,
      testEllipsisMultipleTypes,
      testEllipsisWithNamedParams,
      testEllipsisForwarding,
      testEllipsisUnpacking,
      testEllipsisInStringFormat,
      testAsciiEllipsisMixedWithUnicode
   }
}
