--[[
Known facts to generate the corrupted stack:

* There must be try-except block external to the test function that contains a for loop exercising the hot path.
* If the test throws an error instead of returning normally, the exit path routes through setup_try_handler() which
  resets the stack.  The process of resetting the stack prevents the corruption from occurring.
* The test needs to be run enough times to see the "BC_TRYLEAVE with retdepth=1" message to appear in the log.
* The problem involves the JIT snaphot management
* rec_comp_fixup() in lj_record.cpp may be involved in the snapshot problem.

--]]

test_no = 0
throw_it = 20 -- Set to < hotpath value to forcibly throw an error

@Test(hotpath=10) function NestedBreak()
   test_no++
   print('Test ', test_no, ': NestedBreak')

   if (test_no is throw_it) then error('Intentional throw at iteration ' .. test_no) end
end

   err, result = obj.find('self').mtDebugLog('disasm')
   print(result)
