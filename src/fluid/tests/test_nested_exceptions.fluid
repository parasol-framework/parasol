-- Sophisticated multi-level exception test
-- This test exercises deep nesting of exception handlers to reliably trigger frame chain issues

function testDeepNesting1()
   local result = {}

   catch(function()
      catch(function()
         catch(function()
            catch(function()
               error("Deeply nested error")
            end,
            { ERR_Failed },  -- Wrong filter
            function(Exception)
               table.insert(result, "level4")
            end)
         end,
         { ERR_Failed },  -- Wrong filter
         function(Exception)
            table.insert(result, "level3")
         end)
      end,
      { ERR_Failed },  -- Wrong filter
      function(Exception)
         table.insert(result, "level2")
      end)
   end,
   { ERR_Exception },  -- Correct filter
   function(Exception)
      table.insert(result, "level1")
   end)

   assert(#result == 1 and result[1] == "level1", "Deep nesting filter failed")
end

function testCrossLuaC1()
   local result = {}

   catch(function()
      catch(function()
         local xml = obj.new("xml", { flags="NEW" })
         xml.acDraw()  -- Raises error from C
      end,
      { ERR_Failed },  -- Wrong filter
      function(Exception)
         table.insert(result, "inner")
      end)
   end,
   { ERR_NotSupported },  -- Correct filter
   function(Exception)
      table.insert(result, "outer")
   end)

   assert(#result == 1 and result[1] == "outer", "Lua-C cross boundary exception failed")
end

function testMultipleFilterLevels()
   local result = {}

   catch(function()
      catch(function()
         catch(function()
            local pic = obj.new("picture", { flags="NEW" })
            pic.acDraw()  -- Raises from C
         end,
         { ERR_Failed },  -- Wrong
         function(Exception)
            table.insert(result, "inner")
         end)
      end,
      { ERR_Init },  -- Also wrong
      function(Exception)
         table.insert(result, "middle")
      end)
   end,
   { ERR_NotSupported },  -- Correct
   function(Exception)
      table.insert(result, "outer")
   end)

   assert(#result == 1 and result[1] == "outer", "Multi-filter exception failed")
end

function testMixedLuaErrors()
   local result = {}

   catch(function()
      catch(function()
         catch(function()
            error("Lua error 1")
         end,
         { ERR_Failed },
         function(Exception)
            table.insert(result, "level3")
         end)

         error("Lua error 2")
      end,
      { ERR_Failed },
      function(Exception)
         table.insert(result, "level2")
      end)

      error("Lua error 3")
   end,
   { ERR_Exception },
   function(Exception)
      table.insert(result, "level1")
   end)

   assert(#result == 1 and result[1] == "level1", "Mixed Lua errors failed")
end

function testFilterChaining()
   -- Test the specific pattern from testMissedFilter
   local status, msg = pcall(function()
      catch(function()
         local xml = obj.new("xml", { flags="NEW" })
         xml.acDraw()
      end,
      { ERR_Failed },  -- Filter for the wrong error code
      function(Exception)
         -- Do nothing
      end)
   end)

   assert(status is false, "Filter chaining test failed - exception should propagate")
end

function testObjectMethodErrors()
   local result = {}

   catch(function()
      catch(function()
         local time = obj.new("time", {})
         time.acUndo()  -- Unsupported action
      end,
      { ERR_Failed },
      function(Exception)
         table.insert(result, "wrong")
      end)
   end,
   { ERR_NotSupported },
   function(Exception)
      table.insert(result, "correct")
   end)

   assert(#result == 1 and result[1] == "correct", "Object method error failed")
end

function testChainedObjectCalls()
   local result = {}

   catch(function()
      catch(function()
         catch(function()
            local time1 = obj.new("time", {})
            time1.acUndo()
         end,
         { ERR_Failed },
         function(Exception)
            table.insert(result, "level3")
         end)

         local time2 = obj.new("time", {})
         time2.acUndo()
      end,
      { ERR_Failed },
      function(Exception)
         table.insert(result, "level2")
      end)
   end,
   { ERR_NotSupported },
   function(Exception)
      table.insert(result, "level1")
   end)

   assert(#result == 1 and result[1] == "level1", "Chained object calls failed")
end

return {
   tests = {
      'testDeepNesting1', 'testCrossLuaC1', 'testMultipleFilterLevels',
      'testMixedLuaErrors', 'testFilterChaining', 'testObjectMethodErrors',
      'testChainedObjectCalls'
   }
}
