-- Phase 2 parser regression harness.
--
-- Execute via Flute so the tests are enumerated consistently:
--    parasol tools/flute.fluid --log-warning file=src/fluid/tests/parser_phase2.fluid
-- The harness enables the AST pipeline internally, so no additional
-- command-line flags are required.

local ffi = require('ffi')
ffi.cdef[[ void pf_set_ast_pipeline(int enable); ]]
ffi.C.pf_set_ast_pipeline(1)

local function compile_chunk(label, source)
   local chunk, err = load(source, 'parser.phase2:' .. label)
   assert(chunk, string.format('compile failed (%s): %s', label, tostring(err)))
   local ok, runtime_err = pcall(chunk)
   assert(ok, string.format('runtime failure (%s): %s', label, tostring(runtime_err)))
   print('parser.phase2.ok', label)
end

function testPhase2Pipeline()
   local snippets = {
      { 'function_literal', [[
local function sample(a, b)
   local total = (a or 0) + (b or 0)
   local function scale(value)
      return value * 2
   end
   return scale(total)
end

return sample(3, 4)
]] },
      { 'loop_and_defer', [[
local total = 0
for i = 1, 4 do
   defer
      total = total + 1
   end
   if i % 2 == 0 then
      total += i
   elseif i > 3 then
      break
   end
   if i == 3 then
      continue
   end
   total = total + i
end
return total
]] },
      { 'presence_expr', [[
local data = { key = 'value', nested = { label = 'inner' } }
local choice = data.key ?? 'fallback'
local first, second = 1, 2
first, second = second, first
return choice .. data.nested.label .. first
]] },
      { 'generic_for_table', [[
local sum = 0
local map = { alpha = 1, beta = 2, gamma = 3 }
for key, value in pairs(map) do
   defer
      sum = sum + 1
   end
   if key == 'beta' then
      sum += value
   else
      sum = sum + value
   end
end
return sum
]] },
      { 'assignment_matrix', [[
local lhs, rhs = { values = { 4, 6 } }, {}
lhs.values[1], lhs.values[2], rhs.seed = lhs.values[2], lhs.values[1], lhs.values[1]
lhs.values[1] += rhs.seed or 0
local fallback = rhs.value ?? 5
return lhs.values[1] + fallback
]] },
      { 'goto_ladder', [[
local acc = 0
local index = 0
::loop::
index += 1
if index > 5 then
   goto done
end
if index % 2 == 0 then
   goto loop
end
acc += index
goto loop
::done::
return acc
]] },
   }

   for _, entry in ipairs(snippets) do
      compile_chunk(entry[1], entry[2])
   end

   print('parser.phase2.done')
end

return {
   tests = {
      'testPhase2Pipeline',
   }
}
