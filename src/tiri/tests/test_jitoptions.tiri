-- Test the various JIT options.  This requires that the script is created explicitly as a `tiri' object so that we
-- can set jitOptions.  Success for these tests is determined by reviewing the log.

   include 'tiri' -- Required for JOF flags.

   glSelf = obj.find('self')

   glTestScript = [[
function basic_test()
   hello = 'world'
   index = 0xdeadbeef
   math = 111 * 444 + 999
   time = mSys.preciseTime()
   msg('Test finished.')
end
   basic_test()
]]

   glBadScript = [[
function basic_test()
   hello = 'world'
   time = mSys.preciseTime()
   syntax = error ! here @
   msg('Test finished.')
   >>another_error<<
end
   basic_test()
]]

----------------------------------------------------------------------------------------------------------------------

@Test function TraceTokens()
   -- Should print parse tokens to the log
   script = obj.new('tiri', { statement = glTestScript, jitOptions = JOF_TRACE_TOKENS })
   script.acActivate()
end

-- When using diagnose, all syntax errors should be reported.

@Test function TraceDiagnose()
   msg('--- Testing bad script without DIAGNOSE: Should print 1 error')
   script = obj.new('tiri', { statement = glBadScript })
   script.acActivate()

   msg('--- Testing bad script with DIAGNOSE: Should print 2+ errors')
   script = obj.new('tiri', { statement = glBadScript, jitOptions = JOF_DIAGNOSE })
   script.acActivate()
end

@Test function DumpBytecode()
   -- Will dump debug output to the log
   script = obj.new('tiri', { statement = glTestScript, jitOptions = JOF_DUMP_BYTECODE })
   script.acActivate()
end

@Test function TraceExpect()
   -- Will print traced expectations to the log
   script = obj.new('tiri', { statement = glTestScript, jitOptions = JOF_TRACE_EXPECT })
   script.acActivate()
end

@Test function TraceBoundary()
   -- Will print AST boundary crossing to the log
   script = obj.new('tiri', { statement = glTestScript, jitOptions = JOF_TRACE_BOUNDARY })
   script.acActivate()
end

@Test function Profile()
   -- Should print out timing information
   script = obj.new('tiri', { statement = glTestScript, jitOptions = JOF_PROFILE })
   script.acActivate()
end
