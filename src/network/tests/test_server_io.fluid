--[[
This test checks connectivity and I/O with a server by sending a simple HTTP request over port 80.
--]]

   include 'network'

function printableState(State)
   if State is NTC_CONNECTED then return 'CONNECTED'
   elseif State is NTC_CONNECTING then return 'CONNECTING'
   elseif State is NTC_DISCONNECTED then return 'DISCONNECTED'
   elseif State is NTC_HANDSHAKING then return 'HANDSHAKING'
   else return tostring(State) end
end

----------------------------------------------------------------------------------------------------------------------

@Test(requires='network') function testRawHTTP()
   proc = processing.new({ timeout = 5.0 })
   netsocket = obj.new('netsocket', {
      feedback = function(Socket, State)
         state = printableState(State)
         if state is 'CONNECTING' then
            print('Connecting...')
         elseif state is 'CONNECTED' then
            print('Connected to server.')
            Socket.acWrite('GET /index.html HTTP/1.1\r\nHost: parasol.ws\r\nConnection: close\r\nUser-Agent: Parasol Client\r\n\r\n')
         elseif state is 'DISCONNECTED' then
            print('Disconnected from server.')
            proc.signal()
         else
            print('Unknown netsocket state: ' .. state)
         end
      end,
      incoming = function(Socket)
         print('Incoming data...')
         buffer = string.alloc(1024)
         err, read_len = Socket.acRead(buffer)
         if err is ERR_Okay then
            print(buffer:sub(0,80))
         elseif err is ERR_Disconnected then
            proc.signal()
         else
            error('Read() failed on NetSocket.')
         end
      end
   } )

   netsocket.mtConnect('parasol.ws', 80)

   err = proc.sleep()
   assert(err is ERR_Okay, 'Failed to complete the test: ' .. mSys.GetErrorMsg(err))
end
