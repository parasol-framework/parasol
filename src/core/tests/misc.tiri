-- Core tests not covered by other test files.

-----------------------------------------------------------------------------------------------------------------------
-- Print a list of all actions returned by ActionList()

@Test function ActionList()
   actions = mSys.ActionList()
   for id=0,#actions-1 do
      if actions[id].name?? then
         print(string.format('%d: $%.8x: %s', id-1, actions[id].hash, actions[id].name))
      end
   end
end

-----------------------------------------------------------------------------------------------------------------------
-- Test the ability to inspect the MetaClass Fields array.

@Test function MetaClassArrays()
   field_names = { }
   metaFile = mSys.FindClass('File':hash(), 0)
   fields = metaFile.fields
   for i=0,#fields-1 do
      print(i .. ' ' .. fields[i].name)
      field_names[fields[i].name] = true
   end
   assert(#fields > 15, "Expected at least 15 fields in the File class.")
   assert(field_names['Size'] is true, "Expected to find a field named 'size' in the File class.")
end

-----------------------------------------------------------------------------------------------------------------------

@Test function EnvPath()
   task = mSys.CurrentTask()
   err, path = task.mtGetEnv('PATH')
   assert(err is ERR_Okay, 'Error reading PATH variable: ' .. mSys.GetErrorMsg(err))
   print('PATH: ' .. path)
end

-----------------------------------------------------------------------------------------------------------------------

@Test function PreciseTime()
   time = mSys.PreciseTime()
   assert(time > 0, 'PreciseTime() did not return a positive value.')

   processing.sleep(1)

   -- Acquire a new timestamp and check that the difference is between 1 and 1.5 seconds.

   endTime = mSys.PreciseTime()
   elapsed = endTime - time
   assert((elapsed > 1000000) and (elapsed < 1500000), 'Incorrect elapsed time measurement over a 1 second time interval, got ' .. tostring(elapsed))
end

-----------------------------------------------------------------------------------------------------------------------

@Test function Registry()
   state = mSys.GetSystemState()
   if (state.platform is 'Windows') then
      task = mSys.CurrentTask()
      err, progfiles = task.mtGetEnv('\\HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\ProgramFilesDir')

      assert(err is ERR_Okay, 'Error reading registry key: ' .. mSys.GetErrorMsg(err))
      print('The Windows registry key for program files is "' .. progfiles .. '"')
   end
end

-----------------------------------------------------------------------------------------------------------------------

@Test function ObjectSearches()
   parent = obj.new('xml', { name='TestParent', flags=XMF_NEW })
   child = parent.new('xml', { name='TestFO', flags=XMF_NEW })

   objects = { }
   table.insert(objects, child)

   -- Test FindObject()

   err, obj = mSys.FindObject('TestFO')
   assert(err is ERR_Okay, 'Failed to find object: ' .. mSys.GetErrorMsg(err))

   -- Test ListChildren()

   for i=0,8 do
      local obj = parent.new('xml', { name='TestFO', flags=XMF_NEW })
      table.insert(objects, obj)
   end

   -- Expect 10 children with IDs in descending order.
   children = parent.children()
   assert(err is ERR_Okay, 'Failed in call to ListChildren(): ' .. mSys.GetErrorMsg(err))
   assert(#children is 10, 'Parent object listed ' .. #children .. ' objects.')

   chk = { }
   for i=0,9 do
      chk[objects[i].id] = true
   end

   for i=0,9 do
      assert(chk[children[i]] is true, "Object tables don't match")
   end
end
