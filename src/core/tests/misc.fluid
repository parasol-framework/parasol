-- Core tests not covered by other test files.

-----------------------------------------------------------------------------------------------------------------------
-- Print a list of all actions returned by ActionList()

@Test function testActionList()
   for id, actions in ipairs(mSys.ActionList()) do
      if actions?? and actions.name?? then
         print(string.format('%d: $%.8x: %s', id-1, actions.hash, actions.name))
      end
   end
end

-----------------------------------------------------------------------------------------------------------------------
-- Test the ability to inspect the MetaClass Fields array.

@Test function testMetaClassArrays()
   local metaFile = mSys.FindClass(string.hash('File'), 0)
   for k,f in ipairs(metaFile.fields) do
      print(k .. ' ' .. f.name)
   end
end

-----------------------------------------------------------------------------------------------------------------------

@Test function testEnvPath()
   local task = mSys.CurrentTask()
   local err, path = task.mtGetEnv('PATH')
   if (err is ERR_Okay) then
      print('PATH: ' .. path)
   else
      error('Failed to read PATH variable.')
   end
end

-----------------------------------------------------------------------------------------------------------------------

@Test function testPreciseTime()
   local time = mSys.PreciseTime()
   print(time)
   assert(time > 0, 'PreciseTime() did not return a positive value.')

   processing.sleep(1)

   -- Acquire a new timestamp and check that the difference is between 1 and 1.5 seconds.

   local endTime = mSys.PreciseTime()
   print(endTime, ' = ', endTime - time, ' elapsed microseconds')
   assert(((endTime - time) > 1000000) and ((endTime - time) < 1500000), 'Incorrect elapsed time measurement over a 1 second time interval.')
end

-----------------------------------------------------------------------------------------------------------------------

@Test function testRegistry()
   local state = mSys.GetSystemState()
   if (state.platform is 'Windows') then
      local task = mSys.CurrentTask()
      local err, progfiles = task.mtGetEnv('\\HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\ProgramFilesDir')

      if (err is ERR_Okay) then
         print('The Windows registry key for program files is "' .. progfiles .. '"')
      else
         error('Failed to read Windows registry.')
      end
   end
end

-----------------------------------------------------------------------------------------------------------------------

@Test function testObjectSearches()
   local parent = obj.new('xml', { name='TestParent', flags='NEW' })
   local child = parent.new('xml', { name='TestFO', flags='NEW' })

   local objects = { }
   table.insert(objects, child)

   -- Test FindObject()

   local err, obj = mSys.FindObject('TestFO')
   assert(err is ERR_Okay, 'Failed to find object: ' .. mSys.GetErrorMsg(err))

   -- Test ListChildren()

   for i=0,8 do
      local obj = parent.new('xml', { name='TestFO', flags='NEW' })
      table.insert(objects, obj)
   end

   -- Expect 10 children with IDs in descending order.
   local children = parent.children()
   assert(err is ERR_Okay, 'Failed in call to ListChildren(): ' .. mSys.GetErrorMsg(err))
   assert(#children is 10, 'Parent object listed ' .. #children .. ' objects.')

   local check = { }
   for i=0,9 do
      check[objects[i].id] = true
   end
   for i=0,9 do
      assert(check[children[i]] is true, "Object tables don't match")
   end
end
