-- XQuery arithmetic edge-case tests

   include 'xml'

-----------------------------------------------------------------------------------------------------------------------
-- Medium-length additive chains should iterate without exhausting the stack

function testMediumAdditionChain()
   local count = 40
   local terms = {}
   for index = 1, count do
      terms[index] = tostring(index)
   end
   local expr = table.concat(terms, ' + ')

   local expected = (count * (count + 1)) / 2
   local xq = obj.new('xquery', { statement = expr })
   local err = xq.acActivate()
   assert(err is ERR_Okay, 'Query execution failed: ' .. tostring(xq.errorMsg))
   local result = tonumber(xq.resultString)
   assert(result is expected, 'Medium addition chain should equal ' .. tostring(expected) .. ', got ' .. tostring(result))
end

-----------------------------------------------------------------------------------------------------------------------
-- Long additive chains should complete successfully after the iterative evaluator change

function testLongAdditionChain()
   local count = 400
   local terms = {}
   for index = 1, count do
      terms[index] = tostring(index)
   end
   local expr = table.concat(terms, ' + ')

   local expected = (count * (count + 1)) / 2
   local xq = obj.new('xquery', { statement = expr })
   local err = xq.acActivate()
   assert(err is ERR_Okay, 'Query execution failed: ' .. tostring(xq.errorMsg))
   local result = tonumber(xq.resultString)
   assert(result is expected, 'Long addition chain should equal ' .. tostring(expected) .. ', got ' .. tostring(result))
end

-----------------------------------------------------------------------------------------------------------------------
-- Multiplicative chains should respect left-to-right evaluation without recursion

function testMultiplicationChain()
   local factors = {}
   for index = 2, 10 do
      factors[#factors + 1] = tostring(index)
   end
   local chain = table.concat(factors, ' * ')
   local expr = 'let $unit := 1 return (' .. chain .. ')'

   local expected = 1
   for index = 2, 10 do
      expected *= index
   end

   local xq = obj.new('xquery', { statement = expr })
   local err = xq.acActivate()
   assert(err is ERR_Okay, 'Query execution failed: ' .. tostring(xq.errorMsg))
   local result = tonumber(xq.resultString)
   assert(result is expected, 'Multiplication chain should equal ' .. tostring(expected) .. ', got ' .. tostring(result))
end

-----------------------------------------------------------------------------------------------------------------------
-- Mixed associative and non-associative operators should fall back to recursive evaluation

function testMixedAdditionAndSubtraction()
   local expr = '1 + 2 - 3 + 4'
   local xq = obj.new('xquery', { statement = expr })
   local err = xq.acActivate()
   assert(err is ERR_Okay, 'Query execution failed: ' .. tostring(xq.errorMsg))
   local result = tonumber(xq.resultString)
   assert(result is 4, 'Mixed addition and subtraction should equal 4, got ' .. tostring(result))
end


-----------------------------------------------------------------------------------------------------------------------

return {
   tests = {
      'testMediumAdditionChain', 'testLongAdditionChain', 'testMultiplicationChain', 'testMixedAdditionAndSubtraction'
   }
}
