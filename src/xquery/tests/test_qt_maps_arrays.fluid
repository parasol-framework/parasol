-- QT3-inspired regression tests for maps, arrays, and lookup expressions

   include 'xml'

local SUBSET_FILE = 'modules/qt3_map_array_subset.xml'

local function readExpectation(XmlDoc, Name)
   local base = '/test-set/test-case[@name="' .. Name .. '"]/result'

   local errString, stringValue = XmlDoc.mtEvaluate('string(' .. base .. '/assert-string-value)')
   if errString == ERR_Okay and stringValue and stringValue != '' then
      return { type = 'string', value = stringValue }
   end

   local errEq, eqValue = XmlDoc.mtEvaluate('string(' .. base .. '/assert-eq)')
   if errEq == ERR_Okay and eqValue and eqValue != '' then
      return { type = 'string', value = eqValue }
   end

   local errTrue = select(1, XmlDoc.mtSearch(base .. '/assert-true'))
   if errTrue == ERR_Okay then
      return { type = 'boolean', value = true }
   end

   local errFalse = select(1, XmlDoc.mtSearch(base .. '/assert-false'))
   if errFalse == ERR_Okay then
      return { type = 'boolean', value = false }
   end

   local errError, errorNode = XmlDoc.mtSearch(base .. '/error')
   if errError == ERR_Okay and errorNode and errorNode != 0 then
      local errCode, codeValue = XmlDoc.mtGetAttrib(errorNode, 'code')
      return { type = 'error', code = codeValue or '' }
   end

   return nil
end

local function loadCases(Path)
   local subsetXml = obj.new('xml', { path = Path })
   local cases = { }

   local err = subsetXml.mtSearch('/test-set/test-case', function(XML, TagID)
      local errName, name = subsetXml.mtGetAttrib(TagID, 'name')
      assert(errName == ERR_Okay and name and name != '', 'QT3 test-case is missing a name attribute.')

      local errQuery, query = subsetXml.mtEvaluate('string(/test-set/test-case[@name="' .. name .. '"]/test)')
      assert(errQuery == ERR_Okay and query and query != '', 'QT3 test ' .. name .. ' is missing its query body.')

      local expectation = readExpectation(subsetXml, name)
      assert(expectation, 'QT3 test ' .. name .. ' does not define an assertion.')

      table.insert(cases, {
         name = name,
         query = query,
         expect = expectation
      })
   end)

   if err != ERR_Okay then
      error('Failed to enumerate QT3 subset (' .. Path .. '): ' .. mSys.GetErrorMsg(err))
   end

   return cases
end

local function runQt3Case(TestCase)
   local xq = obj.new('xquery')
   xq.statement = TestCase.query

   local err = xq.acActivate()

   if TestCase.expect.type == 'error' then
      assert(err != ERR_Okay, 'QT3 ' .. TestCase.name .. ' expected an error but succeeded.')
      if TestCase.expect.code and TestCase.expect.code != '' then
         local message = tostring(xq.errorMsg)
         assert(message and string.find(message, TestCase.expect.code, 1, true),
            'Expected error code ' .. TestCase.expect.code .. ', got ' .. tostring(message))
      end
      return
   end

   assert(err == ERR_Okay, 'QT3 ' .. TestCase.name .. ' failed: ' .. tostring(xq.errorMsg))

   local actual = tostring(xq.resultString or '')
   if TestCase.expect.type == 'boolean' then
      local expectedString = TestCase.expect.value and 'true' or 'false'
      assert(actual == expectedString, 'QT3 ' .. TestCase.name .. ' expected ' .. expectedString .. ', got ' .. actual)
   elseif TestCase.expect.type == 'string' then
      assert(actual == TestCase.expect.value, 'QT3 ' .. TestCase.name .. ' expected ' .. TestCase.expect.value .. ', got ' .. actual)
   else
      assert(actual == tostring(TestCase.expect.value), 'QT3 ' .. TestCase.name .. ' expected ' .. tostring(TestCase.expect.value) .. ', got ' .. actual)
   end
end

return {
   init = function(ScriptFolder)
      local subset_path = ScriptFolder .. SUBSET_FILE
      if mSys.AnalysePath(subset_path) != ERR_Okay then
         print('QT3 map/array subset not found at: ' .. subset_path)
         print('Install the optional QT3 package to exercise these tests.')
         return { }
      end

      local cases = loadCases(subset_path)
      local tests = { }

      for _, caseInfo in ipairs(cases) do
         local captured = caseInfo
         local func_name = 'qt3_' .. captured.name
         _G[func_name] = function()
            runQt3Case(captured)
         end
         table.insert(tests, func_name)
      end

      return tests
   end
}
