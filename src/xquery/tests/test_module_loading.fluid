-- XQuery module loading integration tests

   include 'xml'

-----------------------------------------------------------------------------------------------------------------------
-- Basic module import and function call

function testBasicModuleImport()
   -- Initial verification of module file existence and that it is compilable

   local mod_content = file.readAll(glScriptFolder .. '/modules/math_utils.xq')
   assert(mod_content, 'Module file not found: modules/math_utils.xq')
   local compiled_mod = obj.new('xquery', { statement = mod_content })

   -- Test the ability to import the module and run it

   local query = [[
      import module namespace math = "http://example.com/math"
         at "modules/math_utils.xq";

      math:square(5)
   ]]

   local xq = obj.new('xquery', { statement = query, path=glScriptFolder })
   local err = xq.acActivate()
   assert(err == ERR_Okay, 'Module import compilation failed: ' .. tostring(xq.errorMsg))
   assert(tonumber(xq.resultString) == 25, 'Should compute 5^2 = 25, got ' .. tostring(xq.resultString))
end

-----------------------------------------------------------------------------------------------------------------------
-- Return multiple results from more than one function

function testMultipleFunctions()
   local xq = obj.new('xquery', { statement = [[
      import module namespace math = "http://example.com/math"
         at "modules/math_utils.xq";

      (math:square(3), math:cube(2))
   ]], path=glScriptFolder })

   local err = xq.acActivate()
   assert(err == ERR_Okay, 'Multiple function calls failed: ' .. tostring(xq.errorMsg))
   -- Result should be a sequence: "9:8" or similar representation
   local result = tostring(xq.resultString)
   assert(string.find(result, '9', 1, true) and string.find(result, '8', 1, true),
      'Should return both 3^2=9 and 2^3=8, got ' .. result)
end

-----------------------------------------------------------------------------------------------------------------------
-- Access module variables

function testModuleVariables()
   local xq = obj.new('xquery', { statement = [[
      import module namespace math = "http://example.com/math"
         at "modules/math_utils.xq";

      $math:pi
   ]], path=glScriptFolder })

   local err = xq.acActivate()
   assert(err == ERR_Okay, 'Module variable access failed: ' .. tostring(xq.errorMsg))
   local pi_value = tonumber(xq.resultString)
   assert(pi_value and math.abs(pi_value - 3.14159) < 0.00001, 'Should return pi value 3.14159, got ' .. pi_value)

   local vars = xq.variables
   assert(vars, "Expected module variables to be accessible")
   local math_pi_seen = false
   for k,v in pairs(vars) do
      if (v == 'math:pi') then math_pi_seen = true end
   end
   assert(math_pi_seen, "Module variable 'math:pi' not found in variables list")

   local list = xq.functions
   assert(list, "Expected module functions to be accessible")
   local math_count = 0
   for k,v in pairs(list) do
      if (string.sub(v, 1, 5) == 'math:') then math_count = math_count + 1 end
   end
   assert(math_count >= 2, "Module variable 'math:pi' not found in variables list")

   -- Verify feature flags include ModuleImports
   
   assert(string.find(xq.get("$featureFlags"), 'ModuleImports', 1, true), "Expected feature flags to include ModuleImports")
end

-----------------------------------------------------------------------------------------------------------------------
-- Import and use multiple modules

function testMultipleModuleImports()
   -- First, ensure the built-in function fn:upper-case is available
   local xq = obj.new('xquery', { statement = [[fn:upper-case("hello")]], path = glScriptFolder })
   local err = xq.acActivate()
   assert((err == ERR_Okay) and (tostring(xq.resultString) == 'HELLO'), 'Built-in function fn:upper-case not available')

   xq.statement = [[
      import module namespace math = "http://example.com/math"
         at "modules/math_utils.xq";
      import module namespace str = "http://example.com/strings"
         at "modules/string_utils.xq";

      (math:square(4), str:uppercase("hello"))
   ]]

   local err = xq.acActivate()
   assert(err == ERR_Okay, 'Multiple module imports failed: ' .. tostring(xq.errorMsg))
   local result = tostring(xq.resultString)
   assert(string.find(result, '16', 1, true) and string.find(result, 'HELLO', 1, true),
      'Should return both 16 and HELLO, got ' .. result)
end

-----------------------------------------------------------------------------------------------------------------------
-- Module importing other modules (transitive imports)

function testTransitiveImports()
   local xq = obj.new('xquery', { statement = [[
      import module namespace comp = "http://example.com/composite"
         at "modules/composite.xq";

      comp:area(10)
   ]], path=glScriptFolder })

   local err = xq.acActivate()
   assert(err == ERR_Okay, 'Transitive module import failed: ' .. tostring(xq.errorMsg))
   local area = tonumber(xq.resultString) -- area(10) = pi * 10^2 = 314.159
   assert(area and math.abs(area - 314.159) < 0.001, 'Should compute circle area 314.159, got ' .. area)
end

-----------------------------------------------------------------------------------------------------------------------
-- Module loaded once and cached across queries

function testModuleCaching()
   local xq = obj.new('xquery', { statement = [[
      import module namespace math = "http://example.com/math"
         at "modules/math_utils.xq";
      math:square(2)
   ]], path=glScriptFolder })

   local err = xq.acActivate()
   assert(err == ERR_Okay, 'First module use failed: ' .. tostring(xq.errorMsg))
   assert(tonumber(xq.resultString) == 4, 'First query should return 4, got ' .. tostring(xq.resultString))

   -- Second query reusing cached module
   xq.statement = [[
      import module namespace math = "http://example.com/math"
         at "modules/math_utils.xq";
      math:cube(2)
   ]]

   local err = xq.acActivate(query2)
   assert(err == ERR_Okay, 'Cached module use failed: ' .. tostring(xq.errorMsg))
   assert(tonumber(xq.resultString) == 8, 'Second query should return 8, got ' .. tostring(xq.resultString))
end

-----------------------------------------------------------------------------------------------------------------------
-- Detect circular module dependencies

function testCircularDependencyDetection()
   local xq = obj.new('xquery', { statement = [[
      import module namespace a = "http://example.com/circular-a"
         at "modules/circular_a.xq";

      a:call-b()
   ]], path=glScriptFolder })

   local err = xq.acActivate()
   assert(err != ERR_Okay, 'Should detect circular dependency')
   local error_msg = string.lower(tostring(xq.errorMsg))
   assert(string.find(error_msg, 'circular', 1, true), 'Error message should mention circular dependency, got ' .. tostring(xq.errorMsg))
end

-----------------------------------------------------------------------------------------------------------------------
-- Error when module file not found

function testMissingModuleError()
   local xq = obj.new('xquery', { statement = [[
      import module namespace missing = "http://example.com/missing"
         at "modules/nonexistent.xq";

      missing:func()
   ]], path=glScriptFolder })

   local err = xq.acActivate()
   assert(err != ERR_Okay, 'Should fail when loading missing module')
   assert(xq.errorMsg != nil and xq.errorMsg != '', 'Should have error message for missing module')
end

-----------------------------------------------------------------------------------------------------------------------
-- Validate module namespace matches import

function testNamespaceValidation()
   local xq = obj.new('xquery', { statement = [[
      import module namespace expected = "http://example.com/expected"
         at "modules/bad_namespace.xq";

      expected:test()
   ]], path=glScriptFolder })

   local err = xq.acActivate(query)
   assert(err != ERR_Okay, 'Should detect namespace mismatch')
   local error_msg = string.lower(tostring(xq.errorMsg))
   assert(string.find(error_msg, 'namespace', 1, true) or string.find(error_msg, 'mismatch', 1, true),
      'Error message should mention namespace issue, got ' .. tostring(xq.errorMsg))
end

-----------------------------------------------------------------------------------------------------------------------
-- Reject non-library modules on import

function testLibraryModuleValidation()
   local xq = obj.new('xquery', { statement = [[
      import module namespace main = "http://example.com/main"
         at "modules/main_module.xq";

      main:test()
   ]], path=glScriptFolder })

   local err = xq.acActivate(query)
   assert(err != ERR_Okay, 'Should reject non-library module')
   local error_msg = string.lower(tostring(xq.errorMsg))
   assert(string.find(error_msg, 'library', 1, true),
      'Error message should mention library module requirement, got ' .. tostring(xq.errorMsg))
end

-----------------------------------------------------------------------------------------------------------------------

return {
   tests = {
      'testBasicModuleImport', 'testMultipleFunctions', 'testModuleVariables',
      'testMultipleModuleImports', 'testTransitiveImports', 'testModuleCaching',
      'testCircularDependencyDetection', 'testMissingModuleError',
      'testNamespaceValidation', 'testLibraryModuleValidation'
   },
   init = function(ScriptFolder)
      glScriptFolder = ScriptFolder
   end,
   cleanup = function()
   end
}
