-- XPath document and text retrieval function tests

   include 'xml'

local glBaseFolder = 'temp:xpath_documents/'
local glCollectionFolder = glBaseFolder .. 'collection/'
local glTextFolder = glBaseFolder .. 'texts/'

local function writeFile(path, content)
   local file = obj.new('file', { path = path, flags = 'WRITE|NEW' })
   file.acWrite(content)
   file = nil
end

local function ensureFolder(path)
   local err = mSys.CreateFolder(path, 0)
   if (err != ERR_Okay) and (err != ERR_FileExists) then
      error('Failed to create folder ' .. path .. ': ' .. mSys.GetErrorMsg(err))
   end
end

local function setupFixtures()
   mSys.DeleteFile(glBaseFolder)
   ensureFolder(glBaseFolder)
   ensureFolder(glCollectionFolder)
   ensureFolder(glTextFolder)

   writeFile(glBaseFolder .. 'primary.xml', table.concat({
      '<?xml version="1.0"?>',
      '<library>',
         '<section id="A" idrefs="B">',
            '<book code="alpha">First</book>',
         '</section>',
         '<section id="B">',
            '<book code="beta">Second</book>',
         '</section>',
         '<pointer href="secondary.xml"/>',
      '</library>'
   }))

   writeFile(glBaseFolder .. 'secondary.xml', table.concat({
      '<secondary>',
         '<item code="B">Beta</item>',
         '<item code="C">Gamma</item>',
      '</secondary>'
   }))

   writeFile(glCollectionFolder .. 'alpha.xml', table.concat({
      '<doc>',
         '<entry code="alpha"/>',
      '</doc>'
   }))

   writeFile(glCollectionFolder .. 'beta.xml', table.concat({
      '<doc>',
         '<entry code="beta"/>',
      '</doc>'
   }))

   writeFile(glTextFolder .. 'sample.txt', 'First line\r\nSecond line\nThird line')
end

setupFixtures()

local function createPrimaryXml()
   return obj.new('xml', { path = glBaseFolder .. 'primary.xml' })
end

-----------------------------------------------------------------------------------------------------------------------
-- doc() should load external documents relative to the current base

function testDocLoadsSecondaryDocument()
   local xml = createPrimaryXml()
   local value = xml.getKey('doc("' .. glBaseFolder .. 'secondary.xml")/secondary/item[1]/@code')
   assert(value == 'B', 'doc() should expose the first item code, got ' .. nz(value, 'NIL'))
end

function testDocSupportsStringUris()
   local xml = createPrimaryXml()
   local value = xml.getKey('doc("string:<doc><item code=\'inline\'/></doc>")/doc/item/@code')
   assert(value == 'inline', 'doc() should parse inline XML via string: URIs, got ' .. nz(value, 'NIL'))
end

-----------------------------------------------------------------------------------------------------------------------
-- doc-available() should report readability without loading

function testDocAvailable()
   local xml = createPrimaryXml()
   local available = xml.getKey('doc-available("' .. glBaseFolder .. 'secondary.xml")')
   assert(available == 'true', 'doc-available() should report true for existing files')

   local missing = xml.getKey('doc-available("' .. glBaseFolder .. 'missing.xml")')
   assert(missing == 'false', 'doc-available() should report false for missing files')
end

-----------------------------------------------------------------------------------------------------------------------
-- collection() should enumerate XML documents within a folder

function testCollectionEnumeratesFolder()
   local xml = createPrimaryXml()
   local count = tonumber(xml.getKey('count(collection("' .. glCollectionFolder .. '"))'))
   assert(count == 2, 'collection() should return two documents, got ' .. tostring(count))

   local firstCode = xml.getKey('collection("' .. glCollectionFolder .. '")/doc/entry[1]/@code')
   assert(firstCode == 'alpha', 'collection() should expose the first document entry, got ' .. nz(firstCode, 'NIL'))
end

function testUriCollectionReturnsPaths()
   local xml = createPrimaryXml()
   local first = xml.getKey('uri-collection("' .. glCollectionFolder .. '")[1]')
   assert(first:find('alpha.xml', 1, true), 'uri-collection() should return sorted file URIs, got ' .. nz(first, 'NIL'))
end

-----------------------------------------------------------------------------------------------------------------------
-- unparsed-text functions should read and split text resources

function testUnparsedTextNormalisesNewlines()
   local xml = createPrimaryXml()
   local text = xml.getKey('unparsed-text("' .. glTextFolder .. 'sample.txt")')
   assert(text == 'First line\nSecond line\nThird line', 'unparsed-text() should normalise newline sequences, got ' .. nz(text, 'NIL'))
end

function testUnparsedTextAvailable()
   local xml = createPrimaryXml()
   local available = xml.getKey('unparsed-text-available("' .. glTextFolder .. 'sample.txt")')
   assert(available == 'true', 'unparsed-text-available() should report true for readable files')

   local missing = xml.getKey('unparsed-text-available("' .. glTextFolder .. 'missing.txt")')
   assert(missing == 'false', 'unparsed-text-available() should report false for missing files')
end

function testUnparsedTextLinesSplitsContent()
   local xml = createPrimaryXml()
   local second = xml.getKey('unparsed-text-lines("' .. glTextFolder .. 'sample.txt")[2]')
   assert(second == 'Second line', 'unparsed-text-lines() should split by linefeed, got ' .. nz(second, 'NIL'))
end

-----------------------------------------------------------------------------------------------------------------------
-- root() should return the document root and idref() should resolve IDREF attributes

function testRootReturnsDocumentElement()
   local xml = createPrimaryXml()
   local name = xml.getKey('name(root(/library/section[1]/book))')
   assert(name == 'library', 'root() should return the document element, got ' .. nz(name, 'NIL'))
end

function testIdrefResolvesReferencingElements()
   local xml = createPrimaryXml()
   local refName = xml.getKey('name(idref("B")[1])')
   assert(refName == 'section', 'idref() should return the referencing section element, got ' .. nz(refName, 'NIL'))
end

-----------------------------------------------------------------------------------------------------------------------
-- Clean up fixtures after the tests complete

cleanup = function()
   mSys.DeleteFile(glBaseFolder)
end
