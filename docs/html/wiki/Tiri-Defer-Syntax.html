<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-8254DG7MT6"> </script><script>
	   window.dataLayer = window.dataLayer || [];
	   function gtag(){dataLayer.push(arguments);}
	   gtag('js', new Date());
      gtag('config', 'G-8254DG7MT6');</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Kōtuku documentation, machine generated from source">
<meta name="author" content="Paul Manias">
<link rel="icon" href="/favicon.ico">
<title>Kōtuku Wiki</title>
<link href="../css/bootstrap.min.css" rel="stylesheet">
<link href="../css/module-template.css" rel="stylesheet">
<link href="../css/github-markdown.css" rel="stylesheet">
</head>

<body>
<nav class="navbar navbar-expand-sm navbar-dark bg-dark">
  <div class="container-fluid">
    <div class="navbar-header"><a class="navbar-brand" href="../index.html">Kōtuku Framework</a></div>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav"><li class="nav-item">
        <li class="nav-item"><a class="nav-link" href="../gallery.html">Gallery</a></li>
        <li class="nav-item"><a class="nav-link" href="../modules/api.html">API</a></li>
        <li class="nav-item"><a class="nav-link" href="Home.html">Wiki</a></li>
        <li class="nav-item"><a class="nav-link" href="https://github.com/parasol-framework/kotuku">GitHub</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="d-sm-block d-none col-3 sidebar" style="max-width: 230px;">
      <div class="flex-shrink-1 pt-2 pe-2 sticky-top overflow-auto vh-100 b-shadow">

<ul class="list-unstyled">
  <li>
    <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#wiki-collapse" aria-expanded="true">Wiki</button>
    <div class="collapse show" id="wiki-collapse">
      <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 ps-3">
         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#bp-collapse" aria-expanded="false">Build Process</button>
         <div class="collapse" id="bp-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
              <li class="api-ref"><a class="rounded" href="Linux-Builds.html">Linux Builds</a></li>
              <li class="api-ref"><a class="rounded" href="Windows-Builds.html">Windows Builds</a></li>
              <li class="api-ref"><a class="rounded" href="Customising-Your-Build.html">Customising Your Build</a></li>
            </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#tm-collapse" aria-expanded="false">Technical Manuals</button>
         <div class="collapse" id="tm-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
             <li class="api-ref"><a class="rounded" href="Kotuku-Objects.html">Kōtuku Objects</a></li>
             <li class="api-ref"><a class="rounded" href="Kotuku-In-Depth.html">Kōtuku In Depth</a></li>
             <li class="api-ref"><a class="rounded" href="Coding-With-AI.html">Coding With AI</a></li>
           </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#fg-collapse" aria-expanded="false">Tiri</button>
         <div class="collapse" id="fg-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
            <li class="api-ref"><a class="rounded" href="Tiri-Reference-Manual.html">Tiri Reference Manual</a></li>
            <li class="api-ref"><a class="rounded" href="Tiri-Common-API.html">Common API</a></li>
            <li class="api-ref"><a class="rounded" href="Tiri-GUI-API.html">GUI API</a></li>
            <li class="api-ref"><a class="rounded" href="Tiri-HTTPServer-API.html">HTTPServer API</a></li>
            <li class="api-ref"><a class="rounded" href="Tiri-IO-API.html">I/O API</a></li>
            <li class="api-ref"><a class="rounded" href="Tiri-JSON-API.html">JSON API</a></li>
            <li class="api-ref"><a class="rounded" href="Tiri-URL-API.html">URL API</a></li>
            <li class="api-ref"><a class="rounded" href="Tiri-VFX-API.html">VFX API</a></li>
            <li class="api-ref"><a class="rounded" href="Tiri-Widgets.html">Widgets</a></li>
           </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#rrm-collapse" aria-expanded="false">RIPL</button>
         <div class="collapse" id="rrm-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
              <li class="api-ref"><a class="rounded" href="RIPL-Reference-Manual.html">RIPL Reference Manual</a></li>
           </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#tools-collapse" aria-expanded="false">Tools</button>
         <div class="collapse" id="tools-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
              <li class="api-ref"><a class="rounded" href="Origo.html">Origo</a></li>
              <li class="api-ref"><a class="rounded" href="Unit-Testing.html">Flute / Unit Testing</a></li>
           </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#doc-collapse" aria-expanded="false">Doc Generation</button>
         <div class="collapse" id="doc-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
              <li class="api-ref"><a class="rounded" href="Embedded-Document-Formatting.html">Embedded Document Format</a></li>
              <li class="api-ref"><a class="rounded" href="TDL-Reference-Manual.html">TDL Reference Manual</a></li>
              <li class="api-ref"><a class="rounded" href="TDL-Tools.html">TDL Tools</a></li>
           </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#app-collapse" aria-expanded="false">Appendix</button>
         <div class="collapse" id="app-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
             <li class="api-ref"><a class="rounded" href="Action-Reference-Manual.html">Action Reference Manual</a></li>
             <li class="api-ref"><a class="rounded" href="System-Error-Codes.html">System Error Codes</a></li>
           </ul>
         </div></li>
      </ul>
    </div>
  </li>
</ul>

<ul class="list-unstyled">
  <li class="border-top my-3"></li>
  <li>
    <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#mod-collapse" aria-expanded="false">Modules</button>
    <div class="collapse" id="mod-collapse">
      <ul class="btn-toggle-nav list-unstyled fw-normal">
      <li class="api-ref"><a href="../modules/audio.html" class="rounded">Audio</a></li>
      <li class="api-ref"><a href="../modules/core.html" class="rounded">Core</a></li>
      <li class="api-ref"><a href="../modules/display.html" class="rounded">Display</a></li>
      <li class="api-ref"><a href="../modules/font.html" class="rounded">Font</a></li>
      <li class="api-ref"><a href="../modules/network.html" class="rounded">Network</a></li>
      <li class="api-ref"><a href="../modules/regex.html" class="rounded">Regex</a></li>
      <li class="api-ref"><a href="../modules/tiri.html" class="rounded">Tiri</a></li>
      <li class="api-ref"><a href="../modules/vector.html" class="rounded">Vector</a></li>
      <li class="api-ref"><a href="../modules/xml.html" class="rounded">XML</a></li>
      <li class="api-ref"><a href="../modules/xpath.html" class="rounded">XPath</a></li>
      </ul>
    </div>
  </li>
</ul>

<ul class="list-unstyled">
  <li class="border-top my-3"></li>
  <li>
    <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#class-collapse" aria-expanded="false">Classes</button>
    <div class="collapse" id="class-collapse">
      <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 ps-3">
        <li>
          <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#audio-collapse" aria-expanded="false">Audio</button>
          <div class="collapse" id="audio-collapse">
            <ul class="btn-toggle-nav list-unstyled fw-normal pb-1">
            <li><a href="../modules/classes/audio.html" class="rounded">Audio</a></li>
            <li><a href="../modules/classes/sound.html" class="rounded">Sound</a></li>
            </ul>
          </div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#core-collapse" aria-expanded="false">Core</button><div class="collapse" id="core-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a href="../modules/classes/file.html" class="rounded">File</a></li>
        <li><a href="../modules/classes/metaclass.html" class="rounded">MetaClass</a></li>
        <li><a href="../modules/classes/module.html" class="rounded">Module</a></li>
        <li><a href="../modules/classes/storagedevice.html" class="rounded">StorageDevice</a></li>
        <li><a href="../modules/classes/task.html" class="rounded">Task</a></li>
        <li><a href="../modules/classes/thread.html" class="rounded">Thread</a></li>
        <li><a href="../modules/classes/time.html" class="rounded">Time</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#data-collapse" aria-expanded="false">Data</button><div class="collapse" id="data-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a href="../modules/classes/compression.html" class="rounded">Compression</a></li>
        <li><a href="../modules/classes/compressedstream.html" class="rounded">CompressedStream</a></li>
        <li><a href="../modules/classes/config.html" class="rounded">Config</a></li>
        <li><a href="../modules/classes/script.html" class="rounded">Script</a></li>
        <li><a href="../modules/classes/xml.html" class="rounded">XML</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#devices-collapse" aria-expanded="false">Devices</button><div class="collapse" id="devices-collapse"><ul class="btn-toggle-nav list-unstyled pb-1"><li><a href="../modules/classes/controller.html" class="rounded">Controller</a></li></ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#effects-collapse" aria-expanded="false">Effects</button><div class="collapse" id="effects-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a class="rounded" href="../modules/classes/blurfx.html">BlurFX</a></li>
        <li><a class="rounded" href="../modules/classes/colourfx.html">ColourFX</a></li>
        <li><a class="rounded" href="../modules/classes/compositefx.html">CompositeFX</a></li>
        <li><a class="rounded" href="../modules/classes/convolvefx.html">ConvolveFX</a></li>
        <li><a class="rounded" href="../modules/classes/displacementfx.html">DisplacementFX</a></li>
        <li><a class="rounded" href="../modules/classes/filtereffect.html">FilterEffect</a></li>
        <li><a class="rounded" href="../modules/classes/floodfx.html">FloodFX</a></li>
        <li><a class="rounded" href="../modules/classes/imagefx.html">ImageFX</a></li>
        <li><a class="rounded" href="../modules/classes/lightingfx.html">LightingFX</a></li>
        <li><a class="rounded" href="../modules/classes/mergefx.html">MergeFX</a></li>
        <li><a class="rounded" href="../modules/classes/morphologyfx.html">MorphologyFX</a></li>
        <li><a class="rounded" href="../modules/classes/offsetfx.html">OffsetFX</a></li>
        <li><a class="rounded" href="../modules/classes/remapfx.html">RemapFX</a></li>
        <li><a class="rounded" href="../modules/classes/sourcefx.html">SourceFX</a></li>
        <li><a class="rounded" href="../modules/classes/turbulencefx.html">TurbulenceFX</a></li>
        <li><a class="rounded" href="../modules/classes/wavefunctionfx.html">WaveFunctionFX</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#ext-collapse" aria-expanded="false">Extensions</button><div class="collapse" id="ext-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a class="rounded" href="../modules/classes/scintilla.html">Scintilla</a></li>
        <li><a class="rounded" href="../modules/classes/scintillasearch.html">ScintillaSearch</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#gfx-collapse" aria-expanded="false">Graphics</button><div class="collapse" id="gfx-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a class="rounded" href="../modules/classes/bitmap.html">Bitmap</a></li>
        <li><a class="rounded" href="../modules/classes/clipboard.html">Clipboard</a></li>
        <li><a class="rounded" href="../modules/classes/display.html">Display</a></li>
        <li><a class="rounded" href="../modules/classes/document.html">Document</a></li>
        <li><a class="rounded" href="../modules/classes/font.html">Font</a></li>
        <li><a class="rounded" href="../modules/classes/picture.html">Picture</a></li>
        <li><a class="rounded" href="../modules/classes/pointer.html">Pointer</a></li>
        <li><a class="rounded" href="../modules/classes/surface.html">Surface</a></li>
        <li><a class="rounded" href="../modules/classes/svg.html">SVG</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#net-collapse" aria-expanded="false">Network</button><div class="collapse" id="net-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a class="rounded" href="../modules/classes/clientsocket.html">ClientSocket</a></li>
        <li><a class="rounded" href="../modules/classes/http.html">HTTP</a></li>
        <li><a class="rounded" href="../modules/classes/netclient.html">NetClient</a></li>
        <li><a class="rounded" href="../modules/classes/netlookup.html">NetLookup</a></li>
        <li><a class="rounded" href="../modules/classes/netsocket.html">NetSocket</a></li>
        <li><a class="rounded" href="../modules/classes/proxy.html">Proxy</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#vectors-collapse" aria-expanded="false">Vectors</button><div class="collapse" id="vectors-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a class="rounded" href="../modules/classes/vector.html">Vector</a></li>
        <li><a class="rounded" href="../modules/classes/vectorclip.html">VectorClip</a></li>
        <li><a class="rounded" href="../modules/classes/vectorcolour.html">VectorColour</a></li>
        <li><a class="rounded" href="../modules/classes/vectorellipse.html">VectorEllipse</a></li>
        <li><a class="rounded" href="../modules/classes/vectorfilter.html">VectorFilter</a></li>
        <li><a class="rounded" href="../modules/classes/vectorgradient.html">VectorGradient</a></li>
        <li><a class="rounded" href="../modules/classes/vectorgroup.html">VectorGroup</a></li>
        <li><a class="rounded" href="../modules/classes/vectorimage.html">VectorImage</a></li>
        <li><a class="rounded" href="../modules/classes/vectorpath.html">VectorPath</a></li>
        <li><a class="rounded" href="../modules/classes/vectorpattern.html">VectorPattern</a></li>
        <li><a class="rounded" href="../modules/classes/vectorpolygon.html">VectorPolygon</a></li>
        <li><a class="rounded" href="../modules/classes/vectorrectangle.html">VectorRectangle</a></li>
        <li><a class="rounded" href="../modules/classes/vectorscene.html">VectorScene</a></li>
        <li><a class="rounded" href="../modules/classes/vectorshape.html">VectorShape</a></li>
        <li><a class="rounded" href="../modules/classes/vectorspiral.html">VectorSpiral</a></li>
        <li><a class="rounded" href="../modules/classes/vectortext.html">VectorText</a></li>
        <li><a class="rounded" href="../modules/classes/vectortransition.html">VectorTransition</a></li>
        <li><a class="rounded" href="../modules/classes/vectorviewport.html">VectorViewport</a></li>
        <li><a class="rounded" href="../modules/classes/vectorwave.html">VectorWave</a></li>
        </ul></div>
        </li>
      </ul>
    </div>
  </li>
</ul>

</div>
</div>

<div class="col-sm-9" style="max-width: 1200px;">
<div class="docs-content" id="default-page">

<h1>Tiri Defer Syntax</h1>
<h1 id="tiri-defer-syntax-patterns">Tiri Defer Syntax Patterns</h1>
<p>The <code>defer</code> statement in Tiri provides Go-style deferred execution, allowing you to schedule cleanup code that runs automatically when a scope exits. This tutorial explains defer patterns with practical examples.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#basic-defer-syntax">Basic Defer Syntax</a></li>
<li><a href="#understanding-execution-order">Understanding Execution Order</a></li>
<li><a href="#upvalue-capture-vs-argument-snapshot">Upvalue Capture vs Argument Snapshot</a></li>
<li><a href="#resource-cleanup-patterns">Resource Cleanup Patterns</a></li>
<li><a href="#defer-with-multiple-arguments">Defer with Multiple Arguments</a></li>
<li><a href="#scope-and-control-flow">Scope and Control Flow</a></li>
<li><a href="#common-patterns-and-idioms">Common Patterns and Idioms</a></li>
<li><a href="#best-practices">Best Practices</a></li>
<li><a href="#limitations">Limitations</a></li>
</ul>
<h2 id="basic-defer-syntax">Basic Defer Syntax</h2>
<p>The simplest defer schedules a function to execute when the current scope exits:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> processFile<span class="op">()</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">file</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;file&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">path</span><span class="op">=</span><span class="st">&#39;data.txt&#39;</span> <span class="op">})</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Closing file&#39;</span><span class="op">)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">file</span><span class="op">.</span>acFree<span class="op">()</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Work with file</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>   <span class="va">content</span> <span class="op">=</span> <span class="va">file</span><span class="op">.</span>acRead<span class="op">()</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Processing: &#39;</span> <span class="op">..</span> <span class="va">content</span><span class="op">)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- Output:</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- Processing: [file content]</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- Closing file</span></span></code></pre></div>
<p>The deferred function executes <strong>after</strong> the normal function body completes but <strong>before</strong> control returns to the caller.</p>
<h2 id="understanding-execution-order">Understanding Execution Order</h2>
<p>When multiple <code>defer</code> statements exist in the same scope, they execute in <strong>LIFO order</strong> (Last In, First Out) - the last defer registered executes first:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> demonstrateLifo<span class="op">()</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;First defer registered&#39;</span><span class="op">)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Second defer registered&#39;</span><span class="op">)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Third defer registered&#39;</span><span class="op">)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Function body&#39;</span><span class="op">)</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- Output:</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- Function body</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- Third defer registered</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- Second defer registered</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- First defer registered</span></span></code></pre></div>
<p>This LIFO ordering matches the natural resource acquisition pattern - resources acquired last should be released first:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> acquireResources<span class="op">()</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">db</span> <span class="op">=</span> connectDatabase<span class="op">()</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>      <span class="va">db</span><span class="op">:</span>disconnect<span class="op">()</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>   <span class="va">file</span> <span class="op">=</span> openFile<span class="op">(</span><span class="st">&#39;log.txt&#39;</span><span class="op">)</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      <span class="va">file</span><span class="op">:</span><span class="fu">close</span><span class="op">()</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>   <span class="va">lock</span> <span class="op">=</span> acquireLock<span class="op">()</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">lock</span><span class="op">:</span>release<span class="op">()</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Work with resources</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- Cleanup order: lock released, file closed, database disconnected</span></span></code></pre></div>
<h2 id="upvalue-capture-vs-argument-snapshot">Upvalue Capture vs Argument Snapshot</h2>
<p>Understanding the difference between upvalue capture and argument snapshot is crucial for correct defer usage.</p>
<h3 id="upvalue-capture-no-arguments">Upvalue Capture (No Arguments)</h3>
<p>When defer has no arguments, it captures variables as <strong>upvalues</strong> - the deferred function sees the <strong>current value</strong> at execution time:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> demonstrateUpvalues<span class="op">()</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">status</span> <span class="op">=</span> <span class="st">&#39;initial&#39;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Status: &#39;</span> <span class="op">..</span> <span class="va">status</span><span class="op">)</span>  <span class="co">-- Captures &#39;status&#39; as upvalue</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>   <span class="va">status</span> <span class="op">=</span> <span class="st">&#39;modified&#39;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>   <span class="va">status</span> <span class="op">=</span> <span class="st">&#39;final&#39;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Output: Status: final</span></span></code></pre></div>
<p>The defer sees <code>status</code> at the time it executes, which is <code>&#39;final&#39;</code>.</p>
<h3 id="argument-snapshot-with-arguments">Argument Snapshot (With Arguments)</h3>
<p>When defer receives arguments via <code>end(...)</code>, those values are <strong>snapshotted</strong> at registration time:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> demonstrateSnapshot<span class="op">()</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">status</span> <span class="op">=</span> <span class="st">&#39;initial&#39;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>   defer<span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Status: &#39;</span> <span class="op">..</span> <span class="va">s</span><span class="op">)</span>  <span class="co">-- &#39;s&#39; is snapshotted</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">(</span><span class="va">status</span><span class="op">)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>   <span class="va">status</span> <span class="op">=</span> <span class="st">&#39;modified&#39;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>   <span class="va">status</span> <span class="op">=</span> <span class="st">&#39;final&#39;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Output: Status: initial</span></span></code></pre></div>
<p>The argument <code>s</code> receives the value of <code>status</code> <strong>at the time defer was registered</strong>, which is <code>&#39;initial&#39;</code>.</p>
<h3 id="when-to-use-each">When to Use Each</h3>
<p><strong>Use upvalue capture when:</strong></p>
<ul>
<li>You want the cleanup to see the <strong>latest state</strong></li>
<li>The variable won&#39;t change unexpectedly</li>
<li>You&#39;re calling methods on objects (the object reference doesn&#39;t change)</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> simpleFileCleanup<span class="op">()</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">file</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;file&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">path</span><span class="op">=</span><span class="st">&#39;data.txt&#39;</span> <span class="op">})</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">file</span><span class="op">.</span>acFree<span class="op">()</span>  <span class="co">-- Object reference won&#39;t change</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- ... use file ...</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p><strong>Use argument snapshot when:</strong></p>
<ul>
<li>You need to capture <strong>original values</strong> for logging, metrics, or rollback</li>
<li>Variables might be reassigned during function execution</li>
<li>You&#39;re passing primitive values that could change</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> trackOperationDuration<span class="op">()</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">startTime</span> <span class="op">=</span> <span class="fu">os.time</span><span class="op">()</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>   <span class="va">operationId</span> <span class="op">=</span> generateId<span class="op">()</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>   defer<span class="op">(</span><span class="va">opId</span><span class="op">,</span> <span class="va">start</span><span class="op">)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">duration</span> <span class="op">=</span> <span class="fu">os.time</span><span class="op">()</span> <span class="op">-</span> <span class="va">start</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Operation &#39;</span> <span class="op">..</span> <span class="va">opId</span> <span class="op">..</span> <span class="st">&#39; took &#39;</span> <span class="op">..</span> <span class="va">duration</span> <span class="op">..</span> <span class="st">&#39; seconds&#39;</span><span class="op">)</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">(</span><span class="va">operationId</span><span class="op">,</span> <span class="va">startTime</span><span class="op">)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- operationId and startTime might be reused for nested operations</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- but defer will log the original values</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h2 id="resource-cleanup-patterns">Resource Cleanup Patterns</h2>
<h3 id="file-handling">File Handling</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> processTextFile<span class="op">(</span><span class="va">filename</span><span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">file</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;file&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">path</span><span class="op">=</span><span class="va">filename</span> <span class="op">})</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Closing: &#39;</span> <span class="op">..</span> <span class="va">filename</span><span class="op">)</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">file</span><span class="op">.</span>acFree<span class="op">()</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>   <span class="va">content</span> <span class="op">=</span> <span class="va">file</span><span class="op">.</span>acRead<span class="op">()</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Process content</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> <span class="va">content</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="multiple-resources-with-dependencies">Multiple Resources with Dependencies</h3>
<p>When resources have dependencies, use multiple defers. They execute in reverse order, ensuring proper cleanup:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> transferData<span class="op">(</span><span class="va">sourcePath</span><span class="op">,</span> <span class="va">destPath</span><span class="op">)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Open source file</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>   <span class="va">source</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;file&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">path</span><span class="op">=</span><span class="va">sourcePath</span><span class="op">,</span> <span class="va">flags</span><span class="op">=</span><span class="st">&#39;READ&#39;</span> <span class="op">})</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>   defer<span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Closing source: &#39;</span> <span class="op">..</span> <span class="va">path</span><span class="op">)</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">source</span><span class="op">.</span>acFree<span class="op">()</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">(</span><span class="va">sourcePath</span><span class="op">)</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Open destination file</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>   <span class="va">dest</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;file&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">path</span><span class="op">=</span><span class="va">destPath</span><span class="op">,</span> <span class="va">flags</span><span class="op">=</span><span class="st">&#39;WRITE|NEW&#39;</span> <span class="op">})</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>   defer<span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Closing destination: &#39;</span> <span class="op">..</span> <span class="va">path</span><span class="op">)</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>      <span class="va">dest</span><span class="op">.</span>acFree<span class="op">()</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span><span class="op">(</span><span class="va">destPath</span><span class="op">)</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Transfer data</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>   <span class="va">content</span> <span class="op">=</span> <span class="va">source</span><span class="op">.</span>acRead<span class="op">()</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>   <span class="va">dest</span><span class="op">.</span>acWrite<span class="op">(</span><span class="va">content</span><span class="op">)</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- Output:</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co">-- Closing destination: [destPath]</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co">-- Closing source: [sourcePath]</span></span></code></pre></div>
<h3 id="conditional-cleanup">Conditional Cleanup</h3>
<p>You can use upvalues to conditionally execute cleanup:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> conditionalCleanup<span class="op">(</span><span class="va">filename</span><span class="op">,</span> <span class="va">deleteOnError</span><span class="op">)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">file</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;file&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">path</span><span class="op">=</span><span class="va">filename</span><span class="op">,</span> <span class="va">flags</span><span class="op">=</span><span class="st">&#39;WRITE|NEW&#39;</span> <span class="op">})</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>   <span class="va">shouldDelete</span> <span class="op">=</span> <span class="va">deleteOnError</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">file</span><span class="op">.</span>acFree<span class="op">()</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="va">shouldDelete</span> <span class="cf">then</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>         <span class="va">obj</span><span class="op">.</span>delete<span class="op">(</span><span class="va">filename</span><span class="op">)</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>         <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Deleted temporary file: &#39;</span> <span class="op">..</span> <span class="va">filename</span><span class="op">)</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- If an error occurs, shouldDelete remains true</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- On success, set it to false</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>   <span class="va">file</span><span class="op">.</span>acWrite<span class="op">(</span><span class="st">&#39;data&#39;</span><span class="op">)</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>   <span class="va">shouldDelete</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h2 id="defer-with-multiple-arguments">Defer with Multiple Arguments</h2>
<p>Defer can capture multiple arguments for complex cleanup scenarios:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> advancedCleanup<span class="op">()</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">resource</span> <span class="op">=</span> acquireResource<span class="op">(</span><span class="st">&#39;alpha&#39;</span><span class="op">)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>   <span class="va">token</span> <span class="op">=</span> <span class="st">&#39;session-123&#39;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">timestamp</span> <span class="op">=</span> <span class="fu">os.time</span><span class="op">()</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>   defer<span class="op">(</span><span class="va">res</span><span class="op">,</span> <span class="va">tkn</span><span class="op">,</span> <span class="va">ts</span><span class="op">)</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Cleanup started at: &#39;</span> <span class="op">..</span> <span class="va">ts</span><span class="op">)</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Token: &#39;</span> <span class="op">..</span> <span class="va">tkn</span><span class="op">)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>      <span class="va">res</span><span class="op">:</span>release<span class="op">()</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">(</span><span class="va">resource</span><span class="op">,</span> <span class="va">token</span><span class="op">,</span> <span class="va">timestamp</span><span class="op">)</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Even if these change, defer uses original values</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>   <span class="va">resource</span> <span class="op">=</span> acquireResource<span class="op">(</span><span class="st">&#39;beta&#39;</span><span class="op">)</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>   <span class="va">token</span> <span class="op">=</span> <span class="st">&#39;session-456&#39;</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>   <span class="va">timestamp</span> <span class="op">=</span> <span class="fu">os.time</span><span class="op">()</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="passing-functions-as-arguments">Passing Functions as Arguments</h3>
<p>You can pass cleanup functions as arguments for flexible resource management:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> withCustomCleanup<span class="op">(</span><span class="va">resource</span><span class="op">,</span> <span class="va">cleanupHandler</span><span class="op">)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>   defer<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="va">res</span><span class="op">)</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Running custom cleanup&#39;</span><span class="op">)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>      handler<span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">(</span><span class="va">cleanupHandler</span><span class="op">,</span> <span class="va">resource</span><span class="op">)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Work with resource</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- Usage</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>withCustomCleanup<span class="op">(</span><span class="va">myResource</span><span class="op">,</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>   <span class="va">r</span><span class="op">:</span><span class="fu">close</span><span class="op">()</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Custom cleanup complete&#39;</span><span class="op">)</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span><span class="op">)</span></span></code></pre></div>
<h2 id="scope-and-control-flow">Scope and Control Flow</h2>
<p>Defers execute when leaving a scope via any path: normal completion, <code>return</code>, <code>break</code>, or <code>continue</code>.</p>
<h3 id="early-return">Early Return</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> validateAndProcess<span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">file</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;file&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">path</span><span class="op">=</span><span class="st">&#39;output.txt&#39;</span> <span class="op">})</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Cleanup in defer&#39;</span><span class="op">)</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">file</span><span class="op">.</span>acFree<span class="op">()</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> <span class="kw">not</span> <span class="va">data</span> <span class="cf">then</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Invalid data&#39;</span><span class="op">)</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">nil</span>  <span class="co">-- Defer still executes before return</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>   <span class="va">file</span><span class="op">.</span>acWrite<span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> <span class="kw">true</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- Output (on invalid data):</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- Invalid data</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- Cleanup in defer</span></span></code></pre></div>
<h3 id="break-in-loops">Break in Loops</h3>
<p>Defers in loop scope execute when breaking:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> processUntilError<span class="op">(</span><span class="va">items</span><span class="op">)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> <span class="va">i</span><span class="op">,</span> <span class="va">item</span> <span class="kw">in</span> <span class="fu">ipairs</span><span class="op">(</span><span class="va">items</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>      <span class="va">temp</span> <span class="op">=</span> createTemporary<span class="op">(</span><span class="va">item</span><span class="op">)</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">defer</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>         <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Cleaning iteration &#39;</span> <span class="op">..</span> <span class="va">i</span><span class="op">)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>         <span class="va">temp</span><span class="op">:</span>delete<span class="op">()</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="kw">not</span> processItem<span class="op">(</span><span class="va">item</span><span class="op">)</span> <span class="cf">then</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>         <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Error at item &#39;</span> <span class="op">..</span> <span class="va">i</span><span class="op">)</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>         <span class="cf">break</span>  <span class="co">-- Defer executes before breaking</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="continue-in-loops">Continue in Loops</h3>
<p>Defers also execute on <code>continue</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> processFiltered<span class="op">(</span><span class="va">items</span><span class="op">)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> <span class="va">i</span><span class="op">,</span> <span class="va">item</span> <span class="kw">in</span> <span class="fu">ipairs</span><span class="op">(</span><span class="va">items</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>      <span class="va">resource</span> <span class="op">=</span> acquire<span class="op">(</span><span class="va">item</span><span class="op">)</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">defer</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>         <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Releasing resource &#39;</span> <span class="op">..</span> <span class="va">i</span><span class="op">)</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>         <span class="va">resource</span><span class="op">:</span>release<span class="op">()</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="kw">not</span> shouldProcess<span class="op">(</span><span class="va">item</span><span class="op">)</span> <span class="cf">then</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>         <span class="va">continue</span>  <span class="co">-- Defer executes before continuing</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>      process<span class="op">(</span><span class="va">item</span><span class="op">)</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="nested-scopes">Nested Scopes</h3>
<p>Defers respect scope boundaries:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> demonstrateScopes<span class="op">()</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Outer defer&#39;</span><span class="op">)</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>   <span class="cf">do</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      <span class="va">defer</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>         <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Inner defer&#39;</span><span class="op">)</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Inner scope body&#39;</span><span class="op">)</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span>  <span class="co">-- Inner defer executes here</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Outer scope body&#39;</span><span class="op">)</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>  <span class="co">-- Outer defer executes here</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- Output:</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- Inner scope body</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- Inner defer</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- Outer scope body</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- Outer defer</span></span></code></pre></div>
<h2 id="common-patterns-and-idioms">Common Patterns and Idioms</h2>
<h3 id="transaction-rollback-pattern">Transaction Rollback Pattern</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> performTransaction<span class="op">(</span><span class="va">operations</span><span class="op">)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">txn</span> <span class="op">=</span> <span class="va">db</span><span class="op">:</span>beginTransaction<span class="op">()</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>   <span class="va">committed</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="kw">not</span> <span class="va">committed</span> <span class="cf">then</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>         <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Rolling back transaction&#39;</span><span class="op">)</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>         <span class="va">txn</span><span class="op">:</span><span class="fu">rollback</span><span class="op">()</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span> <span class="va">op</span> <span class="kw">in</span> <span class="fu">ipairs</span><span class="op">(</span><span class="va">operations</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>      <span class="va">txn</span><span class="op">:</span><span class="fu">execute</span><span class="op">(</span><span class="va">op</span><span class="op">)</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>   <span class="va">txn</span><span class="op">:</span><span class="fu">commit</span><span class="op">()</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>   <span class="va">committed</span> <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="timing-measurements">Timing Measurements</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> measureExecution<span class="op">(</span><span class="va">taskName</span><span class="op">)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">startTime</span> <span class="op">=</span> <span class="fu">os.time</span><span class="op">()</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>   defer<span class="op">(</span><span class="va">name</span><span class="op">,</span> <span class="va">start</span><span class="op">)</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">duration</span> <span class="op">=</span> <span class="fu">os.time</span><span class="op">()</span> <span class="op">-</span> <span class="va">start</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="va">name</span> <span class="op">..</span> <span class="st">&#39; took &#39;</span> <span class="op">..</span> <span class="va">duration</span> <span class="op">..</span> <span class="st">&#39; seconds&#39;</span><span class="op">)</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">(</span><span class="va">taskName</span><span class="op">,</span> <span class="va">startTime</span><span class="op">)</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Perform task</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>   performLongOperation<span class="op">()</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="lock-acquisition-pattern">Lock Acquisition Pattern</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> withLock<span class="op">(</span><span class="va">lockName</span><span class="op">,</span> <span class="va">fn</span><span class="op">)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">lock</span> <span class="op">=</span> acquireLock<span class="op">(</span><span class="va">lockName</span><span class="op">)</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Releasing lock: &#39;</span> <span class="op">..</span> <span class="va">lockName</span><span class="op">)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">lock</span><span class="op">:</span>release<span class="op">()</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> fn<span class="op">()</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- Usage</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>withLock<span class="op">(</span><span class="st">&#39;resource-lock&#39;</span><span class="op">,</span> <span class="kw">function</span><span class="op">()</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Critical section</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>   modifySharedResource<span class="op">()</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span><span class="op">)</span></span></code></pre></div>
<h3 id="temporary-file-pattern">Temporary File Pattern</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> withTempFile<span class="op">(</span><span class="va">fn</span><span class="op">)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">tempPath</span> <span class="op">=</span> <span class="st">&#39;/tmp/work-&#39;</span> <span class="op">..</span> <span class="fu">os.time</span><span class="op">()</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>   <span class="va">file</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;file&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">path</span><span class="op">=</span><span class="va">tempPath</span><span class="op">,</span> <span class="va">flags</span><span class="op">=</span><span class="st">&#39;WRITE|NEW&#39;</span> <span class="op">})</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>   defer<span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">file</span><span class="op">.</span>acFree<span class="op">()</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>      <span class="va">obj</span><span class="op">.</span>delete<span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Deleted temp file: &#39;</span> <span class="op">..</span> <span class="va">path</span><span class="op">)</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">(</span><span class="va">tempPath</span><span class="op">)</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> fn<span class="op">(</span><span class="va">file</span><span class="op">)</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="state-restoration-pattern">State Restoration Pattern</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> withModifiedState<span class="op">(</span><span class="va">object</span><span class="op">,</span> <span class="va">newState</span><span class="op">)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">previousState</span> <span class="op">=</span> <span class="va">object</span><span class="op">.</span><span class="va">state</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>   <span class="va">object</span><span class="op">.</span><span class="va">state</span> <span class="op">=</span> <span class="va">newState</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>   defer<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">oldState</span><span class="op">)</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Restoring state to: &#39;</span> <span class="op">..</span> <span class="va">oldState</span><span class="op">)</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>      <span class="va">obj</span><span class="op">.</span><span class="va">state</span> <span class="op">=</span> <span class="va">oldState</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">(</span><span class="va">object</span><span class="op">,</span> <span class="va">previousState</span><span class="op">)</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Work with modified state</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>   processObject<span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-place-defers-immediately-after-resource-acquisition">1. Place Defers Immediately After Resource Acquisition</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Good: defer right after acquisition</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> good<span class="op">()</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>   <span class="va">file</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;file&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">path</span><span class="op">=</span><span class="st">&#39;data.txt&#39;</span> <span class="op">})</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">file</span><span class="op">.</span>acFree<span class="op">()</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- ... use file ...</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Bad: defer far from acquisition</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> bad<span class="op">()</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>   <span class="va">file</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;file&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">path</span><span class="op">=</span><span class="st">&#39;data.txt&#39;</span> <span class="op">})</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Many lines of code</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>   doSomething<span class="op">()</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>   doSomethingElse<span class="op">()</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>      <span class="va">file</span><span class="op">.</span>acFree<span class="op">()</span>  <span class="co">-- Easy to forget or misplace</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="2-use-argument-snapshot-for-values-that-might-change">2. Use Argument Snapshot for Values That Might Change</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Good: snapshot values that might change</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> good<span class="op">()</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>   <span class="va">id</span> <span class="op">=</span> generateId<span class="op">()</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>   defer<span class="op">(</span><span class="va">capturedId</span><span class="op">)</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>      logCompletion<span class="op">(</span><span class="va">capturedId</span><span class="op">)</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>   <span class="va">id</span> <span class="op">=</span> generateNewId<span class="op">()</span>  <span class="co">-- Original id is preserved in defer</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- Bad: upvalue might have wrong value</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> bad<span class="op">()</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>   <span class="va">id</span> <span class="op">=</span> generateId<span class="op">()</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>      logCompletion<span class="op">(</span><span class="va">id</span><span class="op">)</span>  <span class="co">-- Will use modified id</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>   <span class="va">id</span> <span class="op">=</span> generateNewId<span class="op">()</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="3-keep-deferred-functions-simple">3. Keep Deferred Functions Simple</h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Good: simple, focused cleanup</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="va">defer</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>   <span class="va">resource</span><span class="op">:</span><span class="fu">close</span><span class="op">()</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- Bad: complex logic in defer</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="va">defer</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> <span class="va">resource</span><span class="op">.</span><span class="va">type</span> is <span class="st">&#39;file&#39;</span> <span class="cf">then</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>      <span class="va">resource</span><span class="op">:</span><span class="fu">close</span><span class="op">()</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>   <span class="cf">elseif</span> <span class="va">resource</span><span class="op">.</span><span class="va">type</span> is <span class="st">&#39;socket&#39;</span> <span class="cf">then</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>      <span class="va">resource</span><span class="op">:</span>disconnect<span class="op">()</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>   <span class="cf">else</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- Complex cleanup logic</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="4-document-defer-intent">4. Document Defer Intent</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> processWithLogging<span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">startTime</span> <span class="op">=</span> <span class="fu">os.time</span><span class="op">()</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Log completion time when function exits</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>   defer<span class="op">(</span><span class="va">start</span><span class="op">)</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">elapsed</span> <span class="op">=</span> <span class="fu">os.time</span><span class="op">()</span> <span class="op">-</span> <span class="va">start</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Processing completed in &#39;</span> <span class="op">..</span> <span class="va">elapsed</span> <span class="op">..</span> <span class="st">&#39;s&#39;</span><span class="op">)</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">(</span><span class="va">startTime</span><span class="op">)</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Process data</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> transform<span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h2 id="limitations">Limitations</h2>
<h3 id="error-path-handling">Error Path Handling</h3>
<p>Defers do <strong>not</strong> currently execute during error unwinding (stack unwinding from exceptions):</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> limitationExample<span class="op">()</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;This will NOT execute if error() is called&#39;</span><span class="op">)</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">error</span><span class="op">(</span><span class="st">&#39;Something went wrong&#39;</span><span class="op">)</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>For error-safe cleanup, use <code>pcall</code>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> errorSafeCleanup<span class="op">()</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">resource</span> <span class="op">=</span> acquire<span class="op">()</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">ok</span><span class="op">,</span> <span class="va">result</span> <span class="op">=</span> <span class="fu">pcall</span><span class="op">(</span><span class="kw">function</span><span class="op">()</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">defer</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>         <span class="va">resource</span><span class="op">:</span>release<span class="op">()</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- Work that might error</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>      riskyOperation<span class="op">()</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">)</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> <span class="kw">not</span> <span class="va">ok</span> <span class="cf">then</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- Handle error</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Error: &#39;</span> <span class="op">..</span> <span class="va">result</span><span class="op">)</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="defer-errors-propagate">Defer Errors Propagate</h3>
<p>Errors in deferred functions propagate normally:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> deferError<span class="op">()</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">error</span><span class="op">(</span><span class="st">&#39;Defer failed&#39;</span><span class="op">)</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Body&#39;</span><span class="op">)</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Output:</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- Body</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- [Error: Defer failed]</span></span></code></pre></div>
<p>To prevent defer errors from aborting execution, use <code>pcall</code> inside the defer:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> safeDeferError<span class="op">()</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pcall</span><span class="op">(</span><span class="kw">function</span><span class="op">()</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>         riskyCleanup<span class="op">()</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span><span class="op">)</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Body&#39;</span><span class="op">)</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="no-defer-outside-function-scope">No Defer Outside Function Scope</h3>
<p>Defer must be used within a function or method:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Invalid: defer at module level</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="va">defer</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span><span class="op">(</span><span class="st">&#39;cleanup&#39;</span><span class="op">)</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- Valid: defer inside function</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> valid<span class="op">()</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>   <span class="va">defer</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span><span class="op">(</span><span class="st">&#39;cleanup&#39;</span><span class="op">)</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<h2 id="summary">Summary</h2>
<p>The <code>defer</code> statement provides:</p>
<ul>
<li><strong>Automatic cleanup</strong>: Resources are released when scope exits</li>
<li><strong>LIFO ordering</strong>: Last defer registered executes first</li>
<li><strong>Guaranteed execution</strong>: Runs on normal exit, return, break, and continue</li>
<li><strong>Flexible capture</strong>: Choose between upvalue capture or argument snapshot</li>
</ul>
<p>Use defer to write cleaner, safer code with deterministic resource management.</p>
<hr>
<p><strong>See Also:</strong></p>
<ul>
<li><a href="Tiri-Reference-Manual.md">Tiri Reference Manual</a> - Complete Tiri language reference</li>
<li><a href="Tiri-Common-API.md">Tiri Common API</a> - File and resource handling utilities</li>
</ul>
</div></div></div></div>

<script src="../js/bootstrap.bundle.min.js"></script>
<script src="../js/base.js"></script>
<script>

   // Auto-open the relevant sidebar branch

   var url = window.location.pathname;
   var filename = url.substring(url.lastIndexOf('/')+1);
   var el = document.querySelector('li[class="api-ref"] > a[href="' + filename + '"]');
   if (el) {
      var parent = getParentNode(el, '[class="collapse"]');
      if (parent) new bootstrap.Collapse(parent, { show: true }); // Causes animation

      el.style.backgroundColor = '#d2f4ea';
   }

   cancelAnimations();
    </script>
  </body>
</html>
