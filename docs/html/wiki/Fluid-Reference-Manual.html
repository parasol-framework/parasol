<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN">
<html xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-8254DG7MT6"> </script><script>
	   window.dataLayer = window.dataLayer || [];
	   function gtag(){dataLayer.push(arguments);}
	   gtag('js', new Date());
      gtag('config', 'G-8254DG7MT6');</script><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Parasol Framework documentation, machine generated from source">
<meta name="author" content="Paul Manias">
<link rel="icon" href="/favicon.ico">
<title>Parasol Wiki - Fluid Reference Manual</title>
<link href="../css/bootstrap.min.css" rel="stylesheet">
<link href="../css/module-template.css" rel="stylesheet">
<link href="../css/github-markdown.css" rel="stylesheet">
</head>

<body>
<nav class="navbar navbar-expand-sm navbar-dark bg-dark">
  <div class="container-fluid">
    <div class="navbar-header"><a class="navbar-brand" href="../index.html">Parasol Framework</a></div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav"><li class="nav-item">
        <li class="nav-item"><a class="nav-link" href="../gallery.html">Gallery</a></li>
        <li class="nav-item"><a class="nav-link" href="../modules/core.html">API</a></li>
        <li class="nav-item"><a class="nav-link" href="Home.html">Wiki</a></li>
        <li class="nav-item"><a class="nav-link" href="https://github.com/parasol-framework/parasol">GitHub</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container-fluid">
<div class="row">
<div class="col-sm-3" style="max-width: 250px;"><div class="flex-shrink-1 pt-2 sticky-top overflow-auto vh-100 b-shadow">

<ul class="list-unstyled">
  <li>
    <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#wiki-collapse" aria-expanded="true">Wiki</button>
    <div class="collapse show" id="wiki-collapse">
      <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 ps-3">
         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#bp-collapse" aria-expanded="false">Build Process</button>
         <div class="collapse" id="bp-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
              <li class="api-ref"><a class="rounded" href="Linux-Builds.html">Linux Builds</a></li>
              <li class="api-ref"><a class="rounded" href="Windows-Builds.html">Windows Builds</a></li>
              <li class="api-ref"><a class="rounded" href="Customising-Your-Build.html">Customising Your Build</a></li>
            </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#tm-collapse" aria-expanded="false">Technical Manuals</button>
         <div class="collapse" id="tm-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
             <li class="api-ref"><a class="rounded" href="Parasol-Objects.html">Parasol Objects</a></li>
             <li class="api-ref"><a class="rounded" href="Parasol-In-Depth.html">Parasol In Depth</a></li>
           </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#fg-collapse" aria-expanded="false">Fluid</button>
         <div class="collapse" id="fg-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
            <li class="api-ref"><a class="rounded" href="Fluid-Reference-Manual.html">Fluid Reference Manual</a></li>
            <li class="api-ref"><a class="rounded" href="Fluid-Common-API.html">Common API</a></li>
            <li class="api-ref"><a class="rounded" href="Fluid-FileSearch-API.html">FileSearch API</a></li>
            <li class="api-ref"><a class="rounded" href="Fluid-GUI-API.html">GUI API</a></li>
            <li class="api-ref"><a class="rounded" href="Fluid-JSON-API.html">JSON API</a></li>
            <li class="api-ref"><a class="rounded" href="Fluid-VFX-API.html">VFX API</a></li>
            <li class="api-ref"><a class="rounded" href="Widgets.html">Widgets</a></li>
           </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#rrm-collapse" aria-expanded="false">RIPL</button>
         <div class="collapse" id="rrm-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
              <li class="api-ref"><a class="rounded" href="RIPL-Reference-Manual.html">RIPL Reference Manual</a></li>
           </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#tools-collapse" aria-expanded="false">Tools</button>
         <div class="collapse" id="tools-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
              <li class="api-ref"><a class="rounded" href="Parasol-Cmd-Tool.html">Parasol Cmd Tool</a></li>
              <li class="api-ref"><a class="rounded" href="Unit-Testing.html">Flute / Unit Testing</a></li>
           </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#doc-collapse" aria-expanded="false">Doc Generation</button>
         <div class="collapse" id="doc-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
              <li class="api-ref"><a class="rounded" href="Embedded-Document-Formatting.html">Embedded Document Format</a></li>
              <li class="api-ref"><a class="rounded" href="FDL-Reference-Manual.html">FDL Reference Manual</a></li>
              <li class="api-ref"><a class="rounded" href="FDL-Tools.html">FDL Tools</a></li>
           </ul>
         </div></li>

         <li><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#app-collapse" aria-expanded="false">Appendix</button>
         <div class="collapse" id="app-collapse">
            <ul class="btn-toggle-nav list-unstyled pb-1">
             <li class="api-ref"><a class="rounded" href="Action-Reference-Manual.html">Action Reference Manual</a></li>
             <li class="api-ref"><a class="rounded" href="System-Error-Codes.html">System Error Codes</a></li>
           </ul>
         </div></li>
      </ul>
    </div>
  </li>
</ul>

<ul class="list-unstyled">
  <li class="border-top my-3"></li>
  <li>
    <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#mod-collapse" aria-expanded="false">Modules</button>
    <div class="collapse" id="mod-collapse">
      <ul class="btn-toggle-nav list-unstyled fw-normal">
      <li class="api-ref"><a href="../modules/audio.html" class="rounded">Audio</a></li>
      <li class="api-ref"><a href="../modules/core.html" class="rounded">Core</a></li>
      <li class="api-ref"><a href="../modules/display.html" class="rounded">Display</a></li>
      <li class="api-ref"><a href="../modules/fluid.html" class="rounded">Fluid</a></li>
      <li class="api-ref"><a href="../modules/font.html" class="rounded">Font</a></li>
      <li class="api-ref"><a href="../modules/network.html" class="rounded">Network</a></li>
      <li class="api-ref"><a href="../modules/vector.html" class="rounded">Vector</a></li>
      </ul>
    </div>
  </li>
</ul>

<ul class="list-unstyled">
  <li class="border-top my-3"></li>
  <li>
    <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#class-collapse" aria-expanded="false">Classes</button>
    <div class="collapse" id="class-collapse">
      <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 ps-3">
        <li>
          <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#audio-collapse" aria-expanded="false">Audio</button>
          <div class="collapse" id="audio-collapse">
            <ul class="btn-toggle-nav list-unstyled fw-normal pb-1">
            <li><a href="../modules/classes/audio.html" class="rounded">Audio</a></li>
            <li><a href="../modules/classes/sound.html" class="rounded">Sound</a></li>
            </ul>
          </div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#core-collapse" aria-expanded="false">Core</button><div class="collapse" id="core-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a href="../modules/classes/file.html" class="rounded">File</a></li>
        <li><a href="../modules/classes/metaclass.html" class="rounded">MetaClass</a></li>
        <li><a href="../modules/classes/module.html" class="rounded">Module</a></li>
        <li><a href="../modules/classes/storagedevice.html" class="rounded">StorageDevice</a></li>
        <li><a href="../modules/classes/task.html" class="rounded">Task</a></li>
        <li><a href="../modules/classes/thread.html" class="rounded">Thread</a></li>
        <li><a href="../modules/classes/time.html" class="rounded">Time</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#data-collapse" aria-expanded="false">Data</button><div class="collapse" id="data-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a href="../modules/classes/compression.html" class="rounded">Compression</a></li>
        <li><a href="../modules/classes/config.html" class="rounded">Config</a></li>
        <li><a href="../modules/classes/script.html" class="rounded">Script</a></li>
        <li><a href="../modules/classes/xml.html" class="rounded">XML</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#devices-collapse" aria-expanded="false">Devices</button><div class="collapse" id="devices-collapse"><ul class="btn-toggle-nav list-unstyled pb-1"><li><a href="../modules/classes/controller.html" class="rounded">Controller</a></li></ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#effects-collapse" aria-expanded="false">Effects</button><div class="collapse" id="effects-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a class="rounded" href="../modules/classes/blurfx.html">BlurFX</a></li>
        <li><a class="rounded" href="../modules/classes/colourfx.html">ColourFX</a></li>
        <li><a class="rounded" href="../modules/classes/compositefx.html">CompositeFX</a></li>
        <li><a class="rounded" href="../modules/classes/convolvefx.html">ConvolveFX</a></li>
        <li><a class="rounded" href="../modules/classes/displacementfx.html">DisplacementFX</a></li>
        <li><a class="rounded" href="../modules/classes/filtereffect.html">FilterEffect</a></li>
        <li><a class="rounded" href="../modules/classes/floodfx.html">FloodFX</a></li>
        <li><a class="rounded" href="../modules/classes/imagefx.html">ImageFX</a></li>
        <li><a class="rounded" href="../modules/classes/lightingfx.html">LightingFX</a></li>
        <li><a class="rounded" href="../modules/classes/mergefx.html">MergeFX</a></li>
        <li><a class="rounded" href="../modules/classes/morphologyfx.html">MorphologyFX</a></li>
        <li><a class="rounded" href="../modules/classes/offsetfx.html">OffsetFX</a></li>
        <li><a class="rounded" href="../modules/classes/remapfx.html">RemapFX</a></li>
        <li><a class="rounded" href="../modules/classes/sourcefx.html">SourceFX</a></li>
        <li><a class="rounded" href="../modules/classes/turbulencefx.html">TurbulenceFX</a></li>
        <li><a class="rounded" href="../modules/classes/wavefunctionfx.html">WaveFunctionFX</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#ext-collapse" aria-expanded="false">Extensions</button><div class="collapse" id="ext-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a class="rounded" href="../modules/classes/scintilla.html">Scintilla</a></li>
        <li><a class="rounded" href="../modules/classes/scintillasearch.html">ScintillaSearch</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#gfx-collapse" aria-expanded="false">Graphics</button><div class="collapse" id="gfx-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a class="rounded" href="../modules/classes/bitmap.html">Bitmap</a></li>
        <li><a class="rounded" href="../modules/classes/clipboard.html">Clipboard</a></li>
        <li><a class="rounded" href="../modules/classes/display.html">Display</a></li>
        <li><a class="rounded" href="../modules/classes/document.html">Document</a></li>
        <li><a class="rounded" href="../modules/classes/font.html">Font</a></li>
        <li><a class="rounded" href="../modules/classes/picture.html">Picture</a></li>
        <li><a class="rounded" href="../modules/classes/pointer.html">Pointer</a></li>
        <li><a class="rounded" href="../modules/classes/surface.html">Surface</a></li>
        <li><a class="rounded" href="../modules/classes/svg.html">SVG</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#net-collapse" aria-expanded="false">Network</button><div class="collapse" id="net-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a class="rounded" href="../modules/classes/clientsocket.html">ClientSocket</a></li>
        <li><a class="rounded" href="../modules/classes/http.html">HTTP</a></li>
        <li><a class="rounded" href="../modules/classes/netsocket.html">NetSocket</a></li>
        <li><a class="rounded" href="../modules/classes/proxy.html">Proxy</a></li>
        </ul></div>
        </li>
        <li>
        <button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle="collapse" data-bs-target="#vectors-collapse" aria-expanded="false">Vectors</button><div class="collapse" id="vectors-collapse"><ul class="btn-toggle-nav list-unstyled pb-1">
        <li><a class="rounded" href="../modules/classes/vector.html">Vector</a></li>
        <li><a class="rounded" href="../modules/classes/vectorclip.html">VectorClip</a></li>
        <li><a class="rounded" href="../modules/classes/vectorcolour.html">VectorColour</a></li>
        <li><a class="rounded" href="../modules/classes/vectorellipse.html">VectorEllipse</a></li>
        <li><a class="rounded" href="../modules/classes/vectorfilter.html">VectorFilter</a></li>
        <li><a class="rounded" href="../modules/classes/vectorgradient.html">VectorGradient</a></li>
        <li><a class="rounded" href="../modules/classes/vectorgroup.html">VectorGroup</a></li>
        <li><a class="rounded" href="../modules/classes/vectorimage.html">VectorImage</a></li>
        <li><a class="rounded" href="../modules/classes/vectorpath.html">VectorPath</a></li>
        <li><a class="rounded" href="../modules/classes/vectorpattern.html">VectorPattern</a></li>
        <li><a class="rounded" href="../modules/classes/vectorpolygon.html">VectorPolygon</a></li>
        <li><a class="rounded" href="../modules/classes/vectorrectangle.html">VectorRectangle</a></li>
        <li><a class="rounded" href="../modules/classes/vectorscene.html">VectorScene</a></li>
        <li><a class="rounded" href="../modules/classes/vectorshape.html">VectorShape</a></li>
        <li><a class="rounded" href="../modules/classes/vectorspiral.html">VectorSpiral</a></li>
        <li><a class="rounded" href="../modules/classes/vectortext.html">VectorText</a></li>
        <li><a class="rounded" href="../modules/classes/vectortransition.html">VectorTransition</a></li>
        <li><a class="rounded" href="../modules/classes/vectorviewport.html">VectorViewport</a></li>
        <li><a class="rounded" href="../modules/classes/vectorwave.html">VectorWave</a></li>
        </ul></div>
        </li>
      </ul>
    </div>
  </li>
</ul>

</div>
</div>

<div class="col-sm-9" style="max-width: 1200px;">
<div class="docs-content" style="display:none;" id="default-page">
<h1>Fluid Reference Manual</h1>
<p>Fluid is a Lua-based scripting language, specially customised for integration with the Parasol Framework. It supports garbage collection, dynamic typing and a bytecode interpreter for compiled code. Lua was chosen as our preferred programming language due to its extensive popularity amongst game developers, a testament to its low overhead, speed and lightweight processing when compared to common scripting languages.</p>
<p>Full compatibility with Parasol&#39;s C++ APIs is included. This includes support for all common constants found in the C headers (e.g. error codes, action ID&#39;s and special flags). Object classes are self-describing, so the need for external libraries or header files to communicate with a given type of object is unnecessary under normal circumstances. Module functions are also self-describing, offering the same level of access to function calls as one would expect when programming in C.</p>
<p>This manual expands on the information in the existing <a href="http://www.lua.org">Lua Reference Manual</a>, and covers features that are exclusive to Fluid. The official Lua 5.1 Reference Manual is required reading before you continue with this document, as a working knowledge of the Lua language is assumed.</p>
<h3 id="further-reading">Further Reading</h3>
<p>For more information on the usage of available classes and modules, please refer to the Parasol API at <a href="https://www.parasol.ws"><span>www.parasol.ws</span></a>.</p>
<p>For general information on the syntax provided by Lua, please read the following online manuals:</p>
<ul>
<li><a href="www.lua.org/manual/"><span>http://www.lua.org/manual/</span></a></li>
<li><a href="/www.lua.org/pil/"><span>http://www.lua.org/pil/</span></a></li>
<li><a href="lua-users.org/wiki/SampleCode"><span>http://lua-users.org/wiki/SampleCode</span></a></li>
</ul>
<hr />
<h2 id="usage">Usage</h2>
<p>To run a Fluid script, use the parasol executable:</p>
<p><code>parasol myfile.fluid</code></p>
<p>Named arguments can be passed to the Fluid script by following the script location with a series of variable values:</p>
<p><code>parasol myfile.fluid name=&quot;John&quot; surname=Bloggs</code></p>
<p>To debug a Fluid script, use the <code>--log-api</code> parameter.</p>
<p>For further information on available options, execute parasol with the <code>--help</code> parameter.</p>
<h3 id="file-recognition">File Recognition</h3>
<p>Fluid files can use the file extension <code>.lua</code> or <code>.fluid</code> for identification. Ideally, scripts should start with the comment <code>-- $FLUID</code> near the start of the document so that they can be correctly identified by the Fluid parser.</p>
<hr />
<h2 id="lua-extensions">Lua Extensions</h2>
<p>A number of extensions have been added (and some features removed) to Lua 5.1 in order to add value to the Fluid language. This section examines the major changes in regards to the published Lua Reference Manual.</p>
<h3 id="removed-features">Removed Features</h3>
<p>The Package, IO and OS libraries normally found in Lua are removed as they duplicate features already found in Parasol&#39;s Script, File and Time classes. The introspective debug library is also removed for the purpose of reducing size.</p>
<h3 id="bitwise-operations">Bitwise Operations</h3>
<p>Bitwise operations are supported via the [<a href="https://bitop.luajit.org/api.html">https://bitop.luajit.org/api.html</a>](bitop API).</p>
<h3 id="comments">Comments</h3>
<p>Single-line C++ style comments are supported in addition to Lua&#39;s commenting standard. For example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> <span class="va">This</span> <span class="va">is</span> <span class="va">a</span> <span class="cn">C</span><span class="er">++</span> <span class="va">style</span><span class="op">,</span> <span class="va">single</span> <span class="va">line</span> <span class="va">comment</span><span class="op">.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">--[[ This is a Lua comment --]]</span></span></code></pre></div>
<h3 id="script-parameters">Script Parameters</h3>
<p>Arguments passed to the Fluid script can be accessed via the <code>arg()</code> function. In the following example either &#39;width&#39; is returned or <code>1024</code> otherwise:</p>
<p><code>width = arg(&#39;width&#39;, 1024)</code></p>
<p>All arguments are managed as strings regardless of the type of the value.</p>
<h3 id="non-zero-value-detection">Non-Zero Value Detection</h3>
<p>A non-zero value detection function, <code>nz()</code>, is included to simplify the handling of nil and zero values (such as a zero length string). Using <code>nz()</code> simplifies program flow where variables must have a value, for example:</p>
<p><code>myvalue = nz(var.shoppinglist, &#39;Empty Basket&#39;)</code></p>
<p>The first parameter is checked if it is empty. If so, the function&#39;s second parameter is returned if provided. Otherwise a value of <code>true</code> is returned.</p>
<hr />
<h2 id="script-management">Script Management</h2>
<h3 id="include">include</h3>
<p>The <code>include</code> statement is used to load the definitions for an API&#39;s functions and classes. It accepts a series of API names as input, and will load each in sequence, for example:</p>
<pre><code>include &#39;core&#39;,&#39;xml&#39;,&#39;display&#39;</code></pre>
<p>API interfaces are protected from being loaded more than once. Calls to <code>mod.load()</code> result in API definitions being loaded automatically, and may make a call to <code>include</code> being unnecessary in that case.</p>
<h3 id="require">require</h3>
<p>The <code>require</code> statement will load a Fluid language file from the <code>scripts:</code> volume and then executes it. It differs from <code>loadFile()</code> in that the script will be registered so as to prevent multiple executions, and the volume restriction improves security.</p>
<h3 id="loadfile">loadFile()</h3>
<p>Use <code>loadFile()</code> to load, parse and execute a Fluid script. This feature is useful for re-using code, or breaking a large project into multiple script files. Example:</p>
<p><code>loadfile(&#39;programs:tools/project/example.fluid&#39;)</code></p>
<p>If the path is not fully qualified, the current path of the process will be used to determine the location of the source file.</p>
<p>If the executed script ends with a <code>return</code> statement, the value(s) will be returned from <code>loadFile()</code> in their original form.</p>
<h3 id="exec">exec()</h3>
<p>Use <code>exec()</code> to parse a Fluid statement and execute it. Can raise an exception if the statement is unparseable or fails during execution. Example:</p>
<p><code>exec(&#39;print(&quot;Hello World&quot;)&#39;)</code></p>
<hr />
<h3 id="exception-handling">Exception Handling</h3>
<p>Calls to the Parasol API do not raise exceptions by default, instead opting to return <code>ERR</code> codes that can be managed by the client (or ignored). Promoting <code>ERR</code> codes to exceptions can be a useful at times, so some functionality is provided to enable this feature as seen in the functions described below.</p>
<h4 id="check">check()</h4>
<p><code>check()</code> is the equivalent of an <code>assert()</code> for <code>ERR</code> codes. Any non-safe error code passed to this function will be converted to an exception with a readable message that matches the <code>ERR</code> code. It is most powerful when used in conjunction with the <code>catch()</code> or <code>pcall()</code> functions, which will apply the line number of the exception to the result. The code will also be propagated to the Script object&#39;s <code>Error</code> field if you are calling the script from C++.</p>
<h4 id="raise">raise()</h4>
<p><code>raise()</code> will raise an exception immediately from an <code>ERR</code> code; for example <code>raise(ERR_Failed)</code>. Unlike <code>check()</code>, all codes have coverage, including minor codes. The error code will also be propagated to the Script object&#39;s <code>Error</code> field if called from a C/C++ program.</p>
<h3 id="error">error()</h3>
<p><code>error()</code> is the standard Lua function for raising exceptions and this is also the case in Fluid. It should be used when raising an exception with a custom error message, e.g. <code>error(&#39;I have failed.&#39;)</code>.</p>
<h4 id="catch">catch()</h4>
<p>Use <code>catch()</code> to switch on exception handling for functions that return <code>ERR</code> codes, as well as regular exceptions that would otherwise be caught by <code>pcall()</code>. Affected code includes: <code>obj.new()</code>; any module function that returns an <code>ERR</code> type; and any method or action call.</p>
<p><code>catch()</code> is typically called with two parameters - the first being a custom function that will be executed, and the second a function handler that will be activated if an exception is raised. The handler will receive an Exception parameter that contains fields that describe what happened. The fields are <code>code</code> for the <code>ERR</code> code (if any); <code>message</code> describes the exception; <code>line</code> is the line number that raised the fault.</p>
<pre><code>catch(function()
    -- Code to execute
end,
function(Exception)
    print(&#39;Code: &#39; .. nz(Exception.code,&#39;LUA&#39;) .. &#39;, Message: &#39; .. Exception.message)
end)</code></pre>
<p>Sometimes it can be convenient to catch only specific error codes of interest, which can be achieved by listing them just prior to the handler reference:</p>
<pre><code>catch(function()
    -- Code to execute
end,
{ ERR_Failed, ERR_Terminate }, -- Errors to catch
fuction(Exception)
end)</code></pre>
<p>Calling <code>catch()</code> without an exception handler will ignore raised exceptions, instead returning the Exception table for further inspection:</p>
<pre><code>local exception = catch(function()
    -- Code to execute
end)</code></pre>
<p>In all other cases the <code>ERR</code> code is returned by default.</p>
<p>Be aware that the scope of catch runs deep, and extends into any functions that are called. Using <code>catch()</code> over a broad section of code is considered mis-use, and can lead to unexpected confusion. Consider using <code>xpcall()</code> instead when broad exception handling is desired.</p>
<p>The following <code>ERR</code> codes are <em>not</em> treated as exceptions:</p>
<p><code>Okay</code>, <code>False</code>, <code>LimitedSuccess</code>, <code>Cancelled</code>, <code>NothingDone</code>, <code>Continue</code>, <code>Skip</code>, <code>Retry</code>, <code>DirEmpty</code>.</p>
<hr />
<h2 id="module-interface">Module Interface</h2>
<p>The module interface provides a means for Fluid programs to communicate with Parasol&#39;s APIs. They are loaded using the <code>mod.load()</code> function, for instance:</p>
<p><code>mGfx = mod.load(&#39;display&#39;)</code></p>
<p>Calling <code>mod.load()</code> returns the function table for the requested module, allowing calls to be made to its functions. For instance:</p>
<p><code>local err, x, y = mGfx.getCursorPos()</code></p>
<p>Notice that Fluid is capable of returning multiple results if a function has declared more than one return value. Typically the first value will be an <code>ERR</code> code.</p>
<p>For consistency, we use a set of commonly named global variables to store module function tables. This is because loading an API more than once is undesirable. The following table illustrates the global names that we use for the default set of APIs.</p>
<table>
<thead>
<tr>
<th>Module</th>
<th>Global Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>audio</td>
<td>mAudio</td>
</tr>
<tr>
<td>code</td>
<td>mSys</td>
</tr>
<tr>
<td>display</td>
<td>mGfx</td>
</tr>
<tr>
<td>font</td>
<td>mFont</td>
</tr>
<tr>
<td>network</td>
<td>mNet</td>
</tr>
<tr>
<td>vector</td>
<td>mVec</td>
</tr>
<tr>
<td>xml</td>
<td>mXML</td>
</tr>
</tbody>
</table>
<p>Taking the above into account, our first example should now be written as follows:</p>
<p><code>if not mGfx then mGfx = mod.load(&#39;display&#39;) end</code></p>
<p>Note that the Core module, identified by the <code>mSys</code> global variable is considered an essential API and is always available by default.</p>
<h3 id="type-conversion">Type Conversion</h3>
<p>When calling an API function, Fluid uses best efforts to convert function values to the types declared in the function definition. For instance, if a string value is used for a numeric argument, Fluid will automatically convert the string to an integer. If the type cannot be converted (for instance, an abstract pointer cannot be converted to a number) then a type mismatch occurs and an exception will be raised.</p>
<p>While type conversion is convenient, we recommend using the correct type whenever possible as this will ensure that your calls are being made efficiently.</p>
<h3 id="buffer-handling">Buffer Handling</h3>
<p>When calling functions that copy results to a user-supplied buffer, pass an array interface. The following example illustrates reading content from a file into an array buffer:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="va">buffer</span> <span class="op">=</span> <span class="va">array</span><span class="op">.</span>new<span class="op">(</span><span class="va">file</span><span class="op">.</span><span class="va">size</span><span class="op">,</span> <span class="st">&#39;byte&#39;</span><span class="op">)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="va">err</span><span class="op">,</span> <span class="va">result</span> <span class="op">=</span> <span class="va">file</span><span class="op">.</span>acRead<span class="op">(</span><span class="va">buffer</span><span class="op">)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="fu">tostring</span><span class="op">(</span><span class="va">buffer</span><span class="op">))</span></span></code></pre></div>
<p>Notice that the <code>acRead()</code> call hasn&#39;t been given its second parameter (the amount of data to read). This is possible because Fluid knows the size of the buffer and will use it for the second parameter if not already defined.</p>
<h3 id="multiple-result-values">Multiple Result Values</h3>
<p>Some functions may return multiple result values. Here is an example of a module function that returns two results:</p>
<p><code>ERR ListMemory(LONG Flags, struct ListMemory **Memory)</code></p>
<p>The first result is an <code>ERR</code> code. The second result is stored in the variable pointed to by the Memory argument. In a C program, this function would be used as follows:</p>
<p><code>if (!ListMemory(0, &amp;memory)) { ... }</code></p>
<p>In Fluid, result-pointer arguments are excluded from the function specification, as the ability to write to variable addresses is a risk to stability. Instead, such arguments are handled internally and their values are returned as part of the result set. The following example shows how to call <code>ListMemory()</code> in Fluid:</p>
<p><code>local err, list = mSys.ListMemory(0)</code></p>
<p>Some functions like the above can return allocated memory or some other form of temporary resource. These are normally marked as such in the function definition, which allows the garbage collector to automatically remove it once its references have been reduced to zero. Remember to use <code>local</code> wherever possible to clean up resources that have gone out of scope.</p>
<hr />
<h2 id="object-interface">Object Interface</h2>
<p>The object interface provides the necessary functionality to create and manage objects. It allows you to read and manipulate object fields, call methods and actions, manage subscriptions and connect to existing named objects.</p>
<h3 id="object-creation">Object Creation</h3>
<p>To create a new object, use the object interface&#39;s <code>new()</code> method with the name of the class that will be instantiated. Here&#39;s an example that creates an object, sets necessary field values and initialises it:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="va">file</span><span class="op">,</span> <span class="va">err</span>  <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;file&#39;</span><span class="op">)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="va">file</span><span class="op">.</span><span class="va">path</span>  <span class="op">=</span> <span class="st">&#39;readme.md&#39;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="va">file</span><span class="op">.</span><span class="va">flags</span> <span class="op">=</span> <span class="st">&#39;!READ&#39;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="va">err</span> <span class="op">=</span> <span class="va">file</span><span class="op">.</span>acInit<span class="op">()</span></span></code></pre></div>
<p>The first result from <code>new()</code> is the created object&#39;s interface and the second result is an <code>ERR</code> code if creation fails. Take note that an object must always be initialised before any real interaction occurs (anything beyond setting field values).</p>
<p>The above example can be greatly simplified by providing a field list immediately after the class name:</p>
<p><code>file = obj.new(&#39;File&#39;, { path=&#39;readme.md&#39;, flags=&#39;!READ&#39; } )</code></p>
<p>In this case the <code>path</code> and <code>flags</code> values will be set on our new object and then initialised automatically (it is assumed <em>all</em> field settings are being defined up-front). The field values may be of any type and Fluid will use best efforts to convert them to the correct field type.</p>
<p>In the event of an error, <code>new()</code> will return <code>nil</code> as the first result and does not throw an exception. We advise guarding against problems by testing the result or by using <code>catch()</code>.</p>
<h3 id="object-relationships">Object Relationships</h3>
<p>Parasol includes an integrated OO feature that allows objects to be attached to each other so that they form parent, child and sibling relationships. By default, all objects created by <code>obj.new()</code> are owned by the Fluid script (which exists as a runtime object).</p>
<p>Sometimes a new object will need to be declared as the child of an existing object. Imagine for instance, that we have a window open and we want to draw a rectangle to it. This can be achieved with something like:</p>
<pre><code>viewport = glWindow:clientViewport({ aspectRatio = ARF_MEET })
viewport.new(&#39;VectorRectangle&#39;, { x=0, y=0, width=&#39;100%&#39;, height=&#39;100%&#39;, fill=&#39;rgb(255,0,0)&#39; })</code></pre>
<p>Notice that the call to <code>viewport.new()</code> looks suspiciously like an <code>obj.new()</code> call. Functionally they are identical, but the key difference is that the rectangle is now going to be a child of the viewport instead of our script. When the rectangle is initialised, it will determine that it is owned by the viewport and will appear in that context when displayed.</p>
<p>It is the case that <em>all</em> objects support the <code>new()</code> method for the purpose of supporting these complex hierarchies.</p>
<p>Be aware that object relationships have absolute priority over other factors in determining their lifetime. In the above example, if the viewport is destroyed (e.g. the user closes the window) then the rectangle will be destroyed with it because its state is linked to the parent. If an object is loosely coupled to a script due to such circumstances, you can call the <code>exists()</code> method at any time on the object&#39;s interface to confirm it is not destroyed.</p>
<h4 id="objectchildren">object.children()</h4>
<p>You can get a list of the children that have been attached to an object by calling the <code>children()</code> method. It returns an array of UID&#39;s that could then be converted to interfaces with <code>obj.find()</code>. The <code>children()</code> method also supports a class filter in the first parameter, e.g. <code>children(&#39;VectorRectangle&#39;)</code> would return a list of all rectangles.</p>
<h3 id="accessing-objects">Accessing Objects</h3>
<p>It is possible to access the interface of an existing object by searching for its name (if given one on initialisation) or UID:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="va">window</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>find<span class="op">(</span><span class="st">&#39;my_window&#39;</span><span class="op">)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="va">winsurface</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>find<span class="op">(</span><span class="va">window</span><span class="op">.</span><span class="va">surface</span><span class="op">)</span></span></code></pre></div>
<p>If failure occurs, <code>nil</code> is returned by the <code>find()</code> method. If multiple objects exist with the same name, the most recently created object is returned first.</p>
<h4 id="objlock">obj:lock()</h4>
<p>If an object is being shared in a threaded program, locking may be necessary to prevent data corruption. This can be achieved by calling <code>lock()</code> and passing a function that will gain an exclusive lock on the object. The lock will remain until the function returns.</p>
<pre><code>obj:lock(function()
   --Code--
end)</code></pre>
<h3 id="garbage-collection">Garbage Collection</h3>
<p>The Lua garbage collector will automatically terminate an object once all references to that object are released or the script is terminated. If an object has a single reference, you can manually terminate it by setting the reference to nil, for example:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="va">file</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;File&#39;</span><span class="op">)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="va">file</span> <span class="op">=</span> <span class="kw">nil</span></span></code></pre></div>
<p>In some cases you may wish to create an object that remains after the script has executed and is not removed by scope rules. To do this, use the <code>detach()</code> method to unlink the object from the garbage collector. The object can still be destroyed manually via a call to its <code>free()</code> method.</p>
<h3 id="action-and-method-calls">Action and Method Calls</h3>
<p>After successfully initialising an object interface, interaction with it is possible through actions, methods and fields. The following example illustrates how we could change the size of the VectorRectangle we created earlier:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="va">rect</span><span class="op">.</span>acRedimension<span class="op">(</span><span class="dv">20</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span></code></pre></div>
<p>Action calls are identified by their <code>ac</code> prefix. Method calls are prefixed by <code>mt</code>. Field references can be directly accessed without a prefix. The naming scheme for methods, actions and fields is case insensitive.</p>
<p>For information about the actions and methods supported by an object class, refer to its published API documentation on our website.</p>
<h3 id="field-interface">Field Interface</h3>
<p>Object fields are accessible by conventional means, i.e. <code>thing = my_object.field_name</code> and <code>my_object.field_name = thing</code> for get and set respectively. There are <code>get()</code> and <code>set()</code> methods that are equivalent to these, and they can be useful in special circumstances such as retrieving a value from an array-based field without first retrieving the entire array:</p>
<p><code>item = view.get(&#39;item(10)&#39;)</code></p>
<p>Some classes support the concept of variable fields, which are unrestricted custom key values that can be added to an object by the client. The <code>getVar()</code> and <code>setVar()</code> methods have been provided to support this feature. For instance:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="va">script</span><span class="op">.</span>setVar<span class="op">(</span><span class="st">&#39;apple&#39;</span><span class="op">,</span> <span class="st">&#39;banana&#39;</span><span class="op">)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="va">banana</span> <span class="op">=</span> <span class="va">script</span><span class="op">.</span>getVar<span class="op">(</span><span class="st">&#39;apple&#39;</span><span class="op">)</span></span></code></pre></div>
<h3 id="bit-fields">Bit Fields</h3>
<p>To test for the presence of a bit in a flag-based field, the following template supported by <code>get()</code> can be used:</p>
<p><code>state = object.get(&#39;flagfield.flagname&#39;)</code></p>
<p>For example:</p>
<p><code>state = surface.get(&#39;flags.visible&#39;)</code></p>
<p>If the named flag is set, a value of 1 is returned, otherwise 0.</p>
<p>To get the value of a flag or lookup field in string format, prefix the name of the field with a <code>$</code> symbol when using the <code>get()</code> method as follows:</p>
<p><code>name = object.get(&#39;$flags&#39;)</code></p>
<hr />
<h2 id="action--method-subscriptions">Action &amp; Method Subscriptions</h2>
<p>Parasol allows clients to monitor the functional execution of an object by subscribing to its actions and methods. One commonly used strategy involves subscribing to the <code>free()</code> action of an object so that the client is notified of object termination.</p>
<p>Subscription is enabled via the <code>subscribe()</code> method. The following example illustrates the creation of an HTTP object that performs a download and calls <code>my_function()</code> on completion of the download process. Note that <code>Args</code> is a table that contains named arguments for the action that was subscribed to. The <code>CustomRef</code> is an optional value that will be passed to the subscriber.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> my_function<span class="op">(</span><span class="cn">UID</span><span class="op">,</span> <span class="va">Args</span><span class="op">,</span> <span class="va">CustomRef</span><span class="op">)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span><span class="op">(</span><span class="st">&#39;Download complete.&#39;</span><span class="op">)</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="va">http</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;http&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span> <span class="op">)</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="va">http</span><span class="op">.</span>acActivate<span class="op">()</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="va">handle</span> <span class="op">=</span> <span class="va">http</span><span class="op">.</span>subscribe<span class="op">(</span><span class="st">&#39;deactivate&#39;</span><span class="op">,</span> <span class="va">my_function</span><span class="op">,</span> <span class="va">customref</span><span class="op">)</span></span></code></pre></div>
<p>To unsubscribe from an action, call <code>unsubscribe()</code> with the action/method name. Doing so will allow the garbage collector to remove associated resources that are no longer required.</p>
<hr />
<h2 id="processing-interface">Processing Interface</h2>
<p>The processing interface assists with the management of your program&#39;s idle state and reaction to signals. Its most basic feature is the commonly used <code>sleep()</code> function, as follows:</p>
<p><code>processing.sleep()</code></p>
<p>Calling <code>sleep()</code> in this way will put the script to sleep until a message is received to awaken it. Typically this means that the function won&#39;t return until a <code>QUIT</code> message is received, which would be delivered if the user opts to close the main window.</p>
<p><code>sleep()</code> can also return early if a timeout in seconds is specified in the first parameter.</p>
<h3 id="signals">Signals</h3>
<p>If a Fluid script is utilising threads, synchronisation can be an important issue that requires careful management. The processing interface makes it possible to put the main thread to sleep and wake it once a series of signals has been triggered. In the following working example, we create a basic thread that prints a message and then signals two XML objects in order to wake the main thread. This might be plausible if we were asking the thread to process XML data for instance:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> testSignals<span class="op">()</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">signal_a</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;xml&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">flags</span><span class="op">=</span><span class="st">&#39;NEW&#39;</span> <span class="op">})</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">signal_b</span> <span class="op">=</span> <span class="va">obj</span><span class="op">.</span>new<span class="op">(</span><span class="st">&#39;xml&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="va">flags</span><span class="op">=</span><span class="st">&#39;NEW&#39;</span> <span class="op">})</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- Note that the thread code is parsed as a string and can&#39;t see any variables without a call to obj.find().</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- The termination handler on the other hand has access to signal the objects directly.</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>   <span class="va">thread</span><span class="op">.</span>script<span class="op">(</span><span class="vs">[[</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      msg(&#39;Thread is now in session.&#39;)</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="vs">   ]]</span><span class="op">,</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>   <span class="kw">function</span><span class="op">()</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>      msg<span class="op">(</span><span class="st">&#39;Thread has been executed.&#39;</span><span class="op">)</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>      <span class="va">signal_a</span><span class="op">.</span>acSignal<span class="op">()</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">signal_b</span><span class="op">.</span>acSignal<span class="op">()</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">)</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">proc</span> <span class="op">=</span> <span class="va">processing</span><span class="op">.</span>new<span class="op">({</span> <span class="va">timeout</span><span class="op">=</span><span class="dv">1.0</span><span class="op">,</span> <span class="va">signals</span> <span class="op">=</span> <span class="op">{</span> <span class="va">signal_a</span><span class="op">,</span> <span class="va">signal_b</span> <span class="op">}</span> <span class="op">})</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>   msg<span class="op">(</span><span class="st">&#39;Sleeping....&#39;</span><span class="op">)</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">err</span> <span class="op">=</span> <span class="va">proc</span><span class="op">.</span>sleep<span class="op">()</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>   <span class="fu">assert</span><span class="op">(</span><span class="va">err</span> <span class="op">==</span> <span class="va">ERR_Okay</span><span class="op">,</span> <span class="st">&quot;Unexpected error: &quot;</span> <span class="op">..</span> <span class="va">mSys</span><span class="op">.</span>GetErrorMsg<span class="op">(</span><span class="va">err</span><span class="op">))</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>Notice that we called <code>processing.new()</code> to create a dedicated interface for signal management. The two objects that will be signalled are passed in via the <code>signals</code> field. When the thread completes, it calls <code>acSignal()</code> on the objects to change their signal state. It is necessary for both objects to change state in order to wake the main thread.</p>
<h3 id="signal">signal()</h3>
<p>If no signal objects are listed in a call to <code>processing.new()</code>, it is possible to manually call the <code>signal()</code> method to wake the sleeping thread instead. This simple technique is sometimes used in passive event systems, e.g. the user clicking a mouse button could result in a <code>signal()</code> call that wakes the main thread.</p>
<hr />
<h2 id="thread-interface">Thread Interface</h2>
<p>Fluid supports a simplified threading model so as to minimise the potential problems occurring from their use. The functionality is as follows:</p>
<h3 id="threadscriptstatement-callback">thread.script(Statement, Callback)</h3>
<p>The <code>script()</code> method compiles a statement string and executes it in a separate script state. The code may not directly share variables with its creator, but it can find existing objects and interact with them by calling <code>obj.find()</code>.</p>
<p>The <code>Callback</code> parameter is a function that will be executed once the threaded script has returned. It executes in the space of the caller and not the thread itself, which means it can access local variables safely.</p>
<pre><code>thread.script([[
   print(&#39;Thread is now in session.&#39;)
]],
function()
   print(&#39;Thread has finished executing.&#39;)
end)</code></pre>
<h3 id="threadactionmethodobject-action-callback-key-args">thread.action|method(Object, Action, Callback, Key, Args...)</h3>
<p>The <code>thread.action()</code> and <code>thread.method()</code> interfaces provide a convenient means of executing an object function in a separate thread. There is some overhead in executing a new thread, but this strategy becomes highly effective when used to perform lengthy processes such as the loading and parsing of data.</p>
<p>Here&#39;s an example that reads the first 1Kb of data from a file and prints the content:</p>
<pre><code>function on_complete(Action, File, Error, Buffer)
   print(&#39;Read string: &#39; .. Buffer)
   File.free()
end

str_buffer = string.rep(1024)
thread.action(file, AC_Read, on_complete, str_buffer, str_buffer)
processing.sleep()</code></pre>
<p>The <code>Action</code> parameter is accepted as an action ID (fast) or a string (slower). The <code>Key</code> makes it possible to pass a custom parameter to the callback, and can be used to pass multiple parameters if a Lua table is used.</p>
<p>The <code>Callback</code> routine receives notification of the thread&#39;s completion, and in this example uses this as an opportunity to free the file object. This is a recommended pattern, and ensures that the target object is not destroyed while the thread is executing. Never declare the object value as <code>local</code>.</p>
<p>Internally, callbacks are executed on the next message processing cycle and this is why a call to <code>processing.sleep()</code> is used in this example.</p>
<p>The <code>Error</code> parameter in the callback reflects the <code>ERR</code> code returned by the action - but bear in mind the possibility that if thread preparation fails, the callback will never be executed and an exception will be thrown instead.</p>
<hr />
<h2 id="structure-interface">Structure Interface</h2>
<p>The structure interface is provided so that Fluid can use C/C++ structures declared in the Parasol API. You will find that many class and module API&#39;s use structures for returning condensed information.</p>
<h3 id="creating-a-structure">Creating a Structure</h3>
<p>Structures are created using the struct interface&#39;s <code>new()</code> method. The prototype is as follows:</p>
<p><code>newstruct = struct.new(struct_def, [address])</code></p>
<p>The struct_def is a reference to a named structure definition declared in the Parasol API, or one returned from <code>MAKESTRUCT()</code>. The address is an optional setting for linking a struct to an existing pointer rather than allocating an empty memory block for the structure. Example:</p>
<p><code>xmltag = struct.new(&#39;XMLTag&#39;, address)</code></p>
<p>It is possible to manually change the address pointer that is assigned to a struct - this saves on having to create a struct object for every address to be processed. Example:</p>
<p><code>oldaddress = xmltag.ptr(NewAddress)</code></p>
<p>To retrieve the current address:</p>
<p><code>address = xmltag.ptr()</code></p>
<p>Note that nil is returned if the address is set to zero.</p>
<h3 id="additional-functionality">Additional Functionality</h3>
<p>The byte size of a structure can be retrieved with the <code>structsize()</code> method, for example:</P></p>
<p><code>print(&#39;The size of the structure is &#39; .. xmltag.structsize())</code></p>
<p>To get the total number of fields in the structure, use <code>#</code>, e.g. <code>#xmltag</code>.</p>
<h3 id="custom-structures">Custom Structures</h3>
<p>The <code>MAKESTRUCT()</code> function is used to build structure definitions. A structure definition is a single string that defines all fields in a structure, matched in the order in which they appear in the structure. Consider the following C structure:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="va">struct</span> XMLTag <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>   <span class="cn">LONG</span>   <span class="va">Index</span><span class="op">;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>   <span class="cn">LONG</span>   <span class="cn">ID</span><span class="op">;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">struct</span> <span class="va">XMLTag</span> <span class="op">*</span><span class="va">Child</span><span class="op">;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>   <span class="va">struct</span> <span class="va">XMLTag</span> <span class="op">*</span><span class="va">Prev</span><span class="op">;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>   <span class="va">struct</span> <span class="va">XMLTag</span> <span class="op">*</span><span class="va">Next</span><span class="op">;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>   <span class="cn">APTR</span>   <span class="va">Private</span><span class="op">;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>   <span class="va">struct</span> <span class="va">XMLAttrib</span> <span class="op">*</span><span class="va">Attrib</span><span class="op">;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>   <span class="cn">WORD</span> <span class="va">TotalAttrib</span><span class="op">;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>   <span class="cn">UWORD</span> <span class="va">Nest</span><span class="op">;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>To define this structure in Fluid we would use the following code:</p>
<p><code>MAKESTRUCT(&#39;XMLTag&#39;, &#39;lIndex,lID,pChild,pPrev:XMLTag,pNext:XMLTag,pPrivate,pAttrib,wTotalAttrib,uwNest&#39;)</code></p>
<p>You will notice that each field name is defined using the same order and names as identified in the structure. Each name is prefixed with a lower-case character that indicates the field type. Using the correct field types is the most crucial part of the structure definition and each must be chosen from the following table:</p>
<table>
<thead>
<tr>
<th>Character</th>
<th>Field Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>l</td>
<td>Long</td>
</tr>
<tr>
<td>d</td>
<td>Double</td>
</tr>
<tr>
<td>x</td>
<td>Large</td>
</tr>
<tr>
<td>f</td>
<td>Float</td>
</tr>
<tr>
<td>w</td>
<td>Word</td>
</tr>
<tr>
<td>c</td>
<td>Char</td>
</tr>
<tr>
<td>p</td>
<td>Pointer. You can use &#39;:StructName&#39; as a suffix to reference other structures.</td>
</tr>
<tr>
<td>s</td>
<td>String</td>
</tr>
<tr>
<td>o</td>
<td>Object (Pointer)</td>
</tr>
<tr>
<td>u</td>
<td>Unsigned (Use in conjunction with a type)</td>
</tr>
</tbody>
</table>
<p>Fixed arrays are also permitted in the structure definition if a field name is followed with enclosed square brackets that contain the array size, e.g. <code>[12]</code>.</p>
<hr />
<h2 id="array-interface">Array Interface</h2>
<p>The array interface is used to manage the arrays that are returned by object fields, actions, methods and certain functions. Although Lua includes native support for arrays, their functionality is particular to the Lua environment. Arrays for use within the Parasol API must use the interface that we provide.</p>
<p>To create an array, use the <code>new()</code> method with the following prototype:</p>
<p><code>myarray = array.new(size, type)</code></p>
<p>The size indicates the total number of entries in the array. The type is a string that declares the type to use for each element in the array. Supported types are <code>byte</code>, <code>word</code>, <code>long</code>, <code>large</code>, <code>string</code>, <code>ptr</code>, <code>float</code> and <code>double</code>.</p>
<p>Strings can also be converted into an array of bytes using the special <code>bytestring</code> type, as in the following template:</p>
<p><code>myarray = array.new(&#39;enter your string here&#39;, &#39;bytestring&#39;)</code></p>
<h3 id="array-indexes">Array Indexes</h3>
<p>Array elements can be retrived using the Lua syntax for array referencing:</p>
<p><code>var = myarray[20]</code></p>
<p>The total number of elements in the array, as defined on the array&#39;s creation, can be retrieved by using the &#39;#&#39; prefix:</p>
<p><code>total = #array</code></p>
<h3 id="arraygetstring">array.getstring()</h3>
<p><code>string = myarray.getstring(Start, [Length])</code></p>
<p>The <code>getstring()</code> method is available for byte arrays only. It converts part of the array into a Lua string. If the <code>Length</code> is unspecified then the full length of the array is retrieved as a string.</p>
<h3 id="arraycopy">array.copy()</h3>
<p><code>array.copy(Source, [DestIndex], [TotalElements])</code></p>
<p>The <code>copy()</code> method is used to copy the data from <code>Source</code> to the array, targeting <code>DestIndex</code>. The <code>Source</code> can be either a <code>string</code> type or another <code>array</code>.</p>
<hr />
<h2 id="logging">Logging</h2>
<p>The following functions are included as standard so that messages can be logged to the console.</p>
<h3 id="msg">msg()</h3>
<p><code>msg()</code> accepts a single string parameter and prints it to the debug log. The log level must be set to <code>api</code> or higher in order to be visible.</p>
<h3 id="print">print()</h3>
<p><code>print()</code> accepts a single string parameter and prints it to <code>stderr</code>. If <code>stderr</code> is unavailable on a system like Android, the message is printed to the debug log instead.</p>
<hr />
<h3 id="event-subsystem">Event Subsystem</h3>
<p>Fluid programs can receive system-wide events whenever they are broadcast. Two functions are provided for the purpose of event management. The first is subscribeEvent(), which will connect a Fluid function to a specific event:</p>
<p><code>error, handle = subscribeEvent(eventname, function)</code></p>
<p>The <code>eventname</code> is a string that must follow the format <code>group.subgroup.name</code>, for example <code>system.task.created</code>. Valid event strings are described in full detail in the Events Manual of the Parasol SDK. A single asterisk wildcard is allowed in the subgroup and/or name if listening to multiple events is desirable, for example <code>system.*.*</code> would listen for all system events. The referenced function will receive two arguments if the event is signalled - <code>EventID</code> and <code>Args</code>. The <code>Args</code> parameter is a table containing named parameters - if the event does not include any parameters then the table will be empty.</p>
<p>To unsubscribe from an event, call unsubscribeEvent() with the event handle that was returned by the initial subscribeEvent() call:</p>
<p><code>unsubscribeEvent(handle)</code></p>
<hr />
<h2 id="credits">Credits</h2>
<p>Fluid is developed by Paul Manias and runs on Mike Pall&#39;s <a href="https://luajit.org/">LuaJIT</a> framework, which in turn is based on the <a href="https://lua.org/">Lua</a> programming language.</p>
<p>Lua is designed and implemented by a team at PUC-Rio, the Pontifical Catholic University of Rio de Janeiro in Brazil. Lua was born and raised at Tecgraf, the Computer Graphics Technology Group of PUC-Rio, and is now housed at Lua.org. Both Tecgraf and Lua.org are laboratories of the Department of Computer Science.</p>
</div></div></div></div>

<script src="../js/bootstrap.bundle.min.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">

   // Auto-open the relevant sidebar branch

   var url = window.location.pathname;
   var filename = url.substring(url.lastIndexOf('/')+1);
   var el = document.querySelector('li[class="api-ref"] > a[href="' + filename + '"]');
   if (el) {
      var parent = getParentNode(el, '[class="collapse"]');
      if (parent) new bootstrap.Collapse(parent, { show: true }); // Causes animation

      el.style.backgroundColor = '#d2f4ea';
   }

   var page = glParameters["page"];
   if (isEmpty(page)) page = glParameters["function"];
   var div = document.getElementById(page);
   if (!div) div = document.getElementById("default-page");
   if (div) div.style.display = "block";

   cancelAnimations();
    </script>
  </body>
</html>
